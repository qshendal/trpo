<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NEXUS ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='Reports.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <h1 class="logo">üîß NEXUS</h1>
        <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
      </div>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-th-large"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-check"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-database"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-shield"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li class="active"><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-line"></i> –û—Ç—á—ë—Ç—ã</a></li>
          <hr style="margin: 20px 0; border: 0; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <li class="logout-item">
              <a href="{{ url_for('admin.logout') }}" class="logout-link" style="color: #fda4af !important;">
                <i class="fas fa-sign-out-alt"></i> <span>–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</span>
              </a>
            </li>
        </ul>
      </nav>
    </aside>

  <main class="dashboard">
    <header class="top-bar">
        <div class="header-title">
            <h2>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h2>
            <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—É–¥–∏—Ç</p>
        </div>
    </header>

    <div class="tabs-container">
        <div class="tabs-pill">
            <button class="tab-button active" data-tab="expenses">
                <i class="fas fa-file-invoice-dollar"></i> –§–∏–Ω–∞–Ω—Å—ã
            </button>
            <button class="tab-button" data-tab="maintenance">
                <i class="fas fa-clipboard-list"></i> –°–µ—Ä–≤–∏—Å
            </button>
        </div>
    </div>

    <div class="tab-content active" id="expenses">
        <div class="filters-card">
            <div class="filter-group">
                <label>–° –¥–∞—Ç—ã</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label>–ü–æ –¥–∞—Ç—É</label>
                <input type="date" id="endDate">
            </div>
            <button class="filter-btn" onclick="loadExpenses()">
                <i class="fas fa-bolt"></i> –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>

        <div id="expensesResults" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue"><i class="fas fa-wallet"></i></div>
                    <div class="stat-info">
                        <label>–ò—Ç–æ–≥–æ –∑–∞—Ç—Ä–∞—Ç</label>
                        <h3 id="expTotalDisplay">0.00 Br</h3>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-info">
                        <label>–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</label>
                        <h3 id="expAvgDisplay">0.00 Br</h3>
                    </div>
                </div>
            </div>

            <div class="report-panel">
                <div class="table-container">
                    <table class="report-table" id="expensesTable">
                        <thead>
                            <tr><th>–ü–µ—Ä–∏–æ–¥</th><th>–°—É–º–º–∞ (Br)</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="export-buttons">
                    <button class="export-btn excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="export-btn pdf" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="maintenance">
        <div class="filters-card">
            <div class="filter-group">
                <label>–ù–∞—á–∞–ª–æ</label>
                <input type="date" id="maintStart">
            </div>
            <div class="filter-group">
                <label>–ö–æ–Ω–µ—Ü</label>
                <input type="date" id="maintEnd">
            </div>
            <button class="filter-btn" onclick="loadMaintenance()">
                <i class="fas fa-search"></i> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>

        <div id="maintenanceResults" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue"><i class="fas fa-tools"></i></div>
                    <div class="stat-info">
                        <label>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</label>
                        <h3 id="maintCountDisplay">0</h3>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green"><i class="fas fa-coins"></i></div>
                    <div class="stat-info">
                        <label>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                        <h3 id="maintTotalDisplay">0.00 Br</h3>
                    </div>
                </div>
            </div>

            <div class="report-panel">
                <div class="table-container">
                    <table class="report-table" id="maintenanceTable">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th><th>–û–±—ä–µ–∫—Ç</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th>–î–µ—Ç–∞–ª–∏</th><th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th><th>–ú–∞—Å—Ç–µ—Ä</th><th>–õ–æ–≥</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="export-buttons">
                    <button class="export-btn excel" onclick="exportMaintenanceExcel()"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="export-btn pdf" onclick="exportMaintenancePDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
            </div>
        </div>
    </div>
</main>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // ===== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ =====
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            tabContents.forEach(tab => tab.classList.remove('active'));
            const targetId = btn.dataset.tab;
            const targetTab = document.getElementById(targetId);
            if (targetTab) targetTab.classList.add('active');
        });
    });

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–∞—Ç (—Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º —á–∏—Å–ª–æ–º)
    const localToday = new Date().toISOString().split('T')[0];
    ["startDate", "endDate", "maintStart", "maintEnd"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.setAttribute("max", localToday);
    });
});

// ====== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ======
const notify = (msg) => alert(msg);

// ====== –ó–ê–¢–†–ê–¢–´ ======
async function loadExpenses() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const btn = event.currentTarget;

    if (!start || !end) { notify("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥!"); return; }

    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';

    try {
        const res = await fetch(`/api/expenses-by-day?start=${start}&end=${end}`);
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
        const data = await res.json();

        const tbody = document.querySelector('#expensesTable tbody');
        tbody.innerHTML = "";
        
        let total = 0;
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" style="text-align:center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</td></tr>';
        } else {
            data.forEach(row => {
                const amount = parseFloat(row.amount);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.date}</td><td><strong>${amount.toLocaleString()} Br</strong></td>`;
                tbody.appendChild(tr);
                total += amount;
            });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º KPI –∫–∞—Ä—Ç–æ—á–∫–∏
        document.getElementById('expTotalDisplay').innerText = `${total.toLocaleString()} Br`;
        const avg = data.length > 0 ? (total / data.length) : 0;
        document.getElementById('expAvgDisplay').innerText = `${avg.toLocaleString(undefined, {maximumFractionDigits: 2})} Br`;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å reportBlock –Ω–∞ expensesResults)
        document.getElementById('expensesResults').classList.remove('hidden');

    } catch (err) {
        console.error(err);
        notify("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –∑–∞—Ç—Ä–∞—Ç–∞–º.");
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
function exportToExcel() {
    const table = document.getElementById("expensesTable");
    const html = table.outerHTML;
    const blob = new Blob(["\ufeff" + html], { type: "application/vnd.ms-excel;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `expenses_report_${new Date().toLocaleDateString()}.xls`;
    a.click();
    URL.revokeObjectURL(url);
}

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.text("–û—Ç—á—ë—Ç –ø–æ –∑–∞—Ç—Ä–∞—Ç–∞–º", 14, 15);
    
    const rows = [];
    document.querySelectorAll("#expensesTable tbody tr").forEach(tr => {
        const cells = tr.querySelectorAll("td");
        if (cells.length >= 2) {
            rows.push([cells[0].innerText, cells[1].innerText]);
        }
    });

    doc.autoTable({
        head: [['–î–∞—Ç–∞', '–°—É–º–º–∞']],
        body: rows,
        startY: 20,
        styles: { font: "helvetica", fontSize: 10 },
        headStyles: { fillColor: [24, 46, 71] }
    });
    doc.save("expenses_report.pdf");
}

// ====== –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï ======
async function loadMaintenance() {
    const start = document.getElementById('maintStart').value;
    const end = document.getElementById('maintEnd').value;
    const btn = event.currentTarget;

    if (!start || !end) { notify("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥!"); return; }

    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';

    try {
        const res = await fetch(`/api/maintenance-report?start=${start}&end=${end}`);
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
        const data = await res.json();

        const tbody = document.querySelector('#maintenanceTable tbody');
        tbody.innerHTML = "";
        
        let totalSum = 0;
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</td></tr>';
        } else {
            data.forEach(row => {
                const amount = parseFloat(row.amount);
                totalSum += amount;
                const tr = document.createElement('tr');
                tr.dataset.id = row.id;
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td><strong>${row.client}</strong></td>
                    <td>${row.contact_person}</td>
                    <td><small>${row.parts || '‚Äî'}</small></td>
                    <td>${amount.toLocaleString()} Br</td>
                    <td><span class="badge-master">${row.technician}</span></td>
                    <td><button class="show-log-btn" onclick="showLog(${row.id}, this)">–õ–æ–≥</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º KPI
        document.getElementById('maintCountDisplay').innerText = data.length;
        document.getElementById('maintTotalDisplay').innerText = `${totalSum.toLocaleString()} Br`;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å maintenanceBlock –Ω–∞ maintenanceResults)
        document.getElementById('maintenanceResults').classList.remove('hidden');

    } catch (err) {
        console.error(err);
        notify("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–∞ –æ–± –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏.");
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
function exportMaintenanceExcel() {
    const table = document.getElementById("maintenanceTable");
    const html = table.outerHTML;
    const blob = new Blob(["\ufeff" + html], { type: "application/vnd.ms-excel;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'maintenance_report.xls';
    a.click();
    URL.revokeObjectURL(url);
}

function exportMaintenancePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // –ê–ª—å–±–æ–º–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–æ–π —Ç–∞–±–ª–∏—Ü—ã
    
    doc.text("–û—Ç—á—ë—Ç –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é", 14, 15);
    
    const rows = [];
    document.querySelectorAll("#maintenanceTable tbody tr").forEach(tr => {
        const cells = tr.querySelectorAll("td");
        if (cells.length >= 6) {
            rows.push([
                cells[0].innerText,
                cells[1].innerText,
                cells[2].innerText,
                cells[3].innerText,
                cells[4].innerText,
                cells[5].innerText
            ]);
        }
    });

    doc.autoTable({
        head: [['–î–∞—Ç–∞', '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è', '–§–ò–û', '–î–µ—Ç–∞–ª—å', '–°—Ç–æ–∏–º–æ—Å—Ç—å', '–ú–∞—Å—Ç–µ—Ä']],
        body: rows,
        startY: 20,
        theme: 'grid',
        styles: { fontSize: 8 },
        headStyles: { fillColor: [24, 46, 71] }
    });
    doc.save("maintenance_report.pdf");
}

// ====== –ò—Å—Ç–æ—Ä–∏—è ======
async function showLog(requestId, btn) {
    const row = document.querySelector(`#maintenanceTable tbody tr[data-id="${requestId}"]`);
    if (!row) return;

    const existingBlock = row.nextElementSibling;
    if (existingBlock && existingBlock.classList.contains("log-row-container")) {
        existingBlock.remove();
        btn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é";
        btn.classList.remove('hide');
        return;
    }

    const originalText = btn.textContent;
    btn.textContent = "‚è≥...";

    try {
        const res = await fetch(`/api/work-log/${requestId}`);
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
        const logs = await res.json();

        const containerTr = document.createElement('tr');
        containerTr.className = "log-row-container";
        
        let html = `<td colspan="7"><div class="log-block">`;
        if (!logs || logs.length === 0) {
            html += "<p>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø—É—Å—Ç–∞.</p>";
        } else {
            html += "<h4>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h4><ul class='log-list'>";
            logs.forEach(l => {
                html += `<li><span class="log-date">${l.–¥–∞—Ç–∞}</span>: <span class="log-desc">${l.–æ–ø–∏—Å–∞–Ω–∏–µ}</span> ${l.–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ? `<small>(${l.–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å})</small>` : ""}</li>`;
            });
            html += "</ul>";
        }
        html += `</div></td>`;
        
        containerTr.innerHTML = html;
        row.after(containerTr);
        
        btn.textContent = "–°–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é";
        btn.classList.add('hide');
    } catch (err) {
        console.error(err);
        btn.textContent = originalText;
        notify("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.");
    }
}
</script>