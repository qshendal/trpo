<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ ‚Äî –û—Ç—á—ë—Ç—ã</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='reports.css') }}">
</head>
<body>
  <div class="container">
    <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
    <aside class="sidebar">
      <h1 class="logo">üîß –¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h1>
      <p class="subtitle">–û—Ç—á—ë—Ç—ã</p>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-alt"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-boxes"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-cog"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã</a></li>
        </ul>
      </nav>
    </aside>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <main class="dashboard">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
      <header class="top-bar">
        <h2>–û—Ç—á—ë—Ç—ã</h2>
        <div class="export-buttons">
          <button class="export-btn pdf"><i class="fas fa-file-pdf"></i> PDF</button>
          <button class="export-btn excel"><i class="fas fa-file-excel"></i> Excel</button>
        </div>
      </header>

      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
      <div class="tabs-wrapper">
        <button class="tab-button active" data-tab="expenses">
          <i class="fas fa-money-bill-wave"></i> –ó–∞—Ç—Ä–∞—Ç—ã
        </button>
        <button class="tab-button" data-tab="maintenance">
          <i class="fas fa-clipboard-check"></i> –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
        </button>
      </div>

      <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <div class="filters-panel">
        <div class="filters-row">
          <!-- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ -->
          <div class="filter-group">
            <label for="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</label>
            <select id="equipment" class="filter-select" multiple size="8">
              <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </select>
          </div>

          <!-- –ú–∞—Å—Ç–µ—Ä -->
          <div class="filter-group">
            <label for="master">–ú–∞—Å—Ç–µ—Ä:</label>
            <select id="master" class="filter-select" multiple size="8">
              <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </select>
          </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å–ø—Ä–∞–≤–∞ -->
        <div class="filter-actions">
          <button id="applyFilters" class="action-btn">
            <i class="fas fa-check"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
          </button>
          <button id="resetFilters" class="action-btn">
            <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å
          </button>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –æ—Ç—á–µ—Ç–æ–≤ -->
      <div class="task-section">
        <!-- –û—Ç—á–µ—Ç—ã –ø–æ –∑–∞—Ç—Ä–∞—Ç–∞–º -->
        <div class="tab-content active" id="expensesContent">
          <div class="report-container">
            <h3>üìä –û—Ç—á—ë—Ç—ã –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</h3>
            <table class="report-table" id="costReportsTable">
              <thead>
                <tr>
                  <th>ID –æ—Ç—á–µ—Ç–∞</th>
                  <th>–ü–µ—Ä–∏–æ–¥</th>
                  <th>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
                  <th>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç—Ä—É–¥–∞</th>
                  <th>–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—á–∞—Å—Ç–µ–π</th>
                  <th>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                  <th>–ó–∞–¥–∞—á–∏</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="reportsData">
                <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- –û—Ç—á–µ—Ç—ã –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é -->
        <div class="tab-content" id="maintenanceContent">
          <div class="report-container">
            <h3>üõ†Ô∏è –û—Ç—á—ë—Ç—ã –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é</h3>
            <div class="empty-state" id="maintenanceEmpty">
              <i class="fas fa-clipboard-list"></i>
              <p>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∫–ª–∞–¥–∫—É "–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
    const API_ENDPOINTS = {
      equipment: '/api/reports/equipment-list',
      masters: '/api/reports/masters-list',
      expenses: '/api/reports/expenses',
      maintenance: '/api/reports/maintenance'
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      loadFilterOptions();
      loadReports('expenses');
      setupEventListeners();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    async function loadFilterOptions() {
      try {
        // –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
        const equipmentRes = await fetch(API_ENDPOINTS.equipment);
        const equipment = await equipmentRes.json();
        populateSelect('#equipment', equipment);
        
        // –ú–∞—Å—Ç–µ—Ä–∞
        const mastersRes = await fetch(API_ENDPOINTS.masters);
        const masters = await mastersRes.json();
        populateSelect('#master', masters);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤
    async function loadReports(type) {
      try {
        const filters = getCurrentFilters();
        const endpoint = type === 'expenses' ? API_ENDPOINTS.expenses : API_ENDPOINTS.maintenance;
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(filters)
        });
        
        const data = await response.json();
        renderReports(type, data);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:', error);
        showEmptyState(type);
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function getCurrentFilters() {
      const equipmentSelect = document.getElementById('equipment');
      const masterSelect = document.getElementById('master');
      
      return {
        equipment: Array.from(equipmentSelect.selectedOptions).map(opt => opt.value),
        master: Array.from(masterSelect.selectedOptions).map(opt => opt.value)
      };
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Ç—á–µ—Ç–æ–≤
    function renderReports(type, data) {
      let tbody;
      let emptyElement;
      
      if (type === 'expenses') {
        tbody = document.getElementById('reportsData');
        emptyElement = document.querySelector('#expensesContent .empty-state');
      } else {
        tbody = document.createElement('tbody');
        const container = document.querySelector('#maintenanceContent .task-inner-cards');
        container.innerHTML = '';
        const table = document.createElement('table');
        table.className = 'report-table';
        table.innerHTML = `
          <thead>
            <tr>
              <th>ID –∑–∞—è–≤–∫–∏</th>
              <th>–î–∞—Ç–∞</th>
              <th>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
              <th>–ú–∞—Å—Ç–µ—Ä</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
              <th>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
              <th>–î–µ—Ç–∞–ª–∏</th>
            </tr>
          </thead>
        `;
        tbody = document.createElement('tbody');
        table.appendChild(tbody);
        container.appendChild(table);
        emptyElement = document.getElementById('maintenanceEmpty');
      }
      
      if (!data || data.length === 0) {
        showEmptyState(type);
        return;
      }
      
      let html = '';
      if (type === 'expenses') {
        data.forEach((report, index) => {
          html += `
            <tr>
              <td>RPT${String(index + 1).padStart(3, '0')}</td>
              <td>${report.period || '–ù/–î'}</td>
              <td>${report.equipment || '–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'}</td>
              <td>$${formatCurrency(report.labor_cost)}</td>
              <td>$${formatCurrency(report.parts_cost)}</td>
              <td><strong>$${formatCurrency(report.total_cost)}</strong></td>
              <td>${report.tasks_count || 0}</td>
              <td>
                <button class="action-btn" onclick="viewReport('expenses', ${report.id})">
                  <i class="fas fa-eye"></i> View
                </button>
                <button class="action-btn" onclick="exportReport('expenses', ${report.id})">
                  <i class="fas fa-download"></i> Export
                </button>
              </td>
            </tr>
          `;
        });
      } else {
        data.forEach((report, index) => {
          html += `
            <tr>
              <td>${report.request_id || '–ù/–î'}</td>
              <td>${report.date || '–ù/–î'}</td>
              <td>${report.equipment || '–ù/–î'}</td>
              <td>${report.master || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</td>
              <td><span class="task-priority ${report.status || 'medium'}">${report.status_text || '–ù/–î'}</span></td>
              <td>$${formatCurrency(report.cost)}</td>
              <td>${report.duration || '–ù/–î'}</td>
              <td>
                <button class="action-btn" onclick="viewReport('maintenance', ${report.id})">
                  <i class="fas fa-eye"></i> –î–µ—Ç–∞–ª–∏
                </button>
              </td>
            </tr>
          `;
        });
      }
      
      tbody.innerHTML = html;
      if (emptyElement) emptyElement.style.display = 'none';
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function populateSelect(selector, items) {
      const select = document.querySelector(selector);
      if (!select) return;
      
      select.innerHTML = '';
      
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        select.appendChild(option);
      });
    }

    function formatCurrency(amount) {
      if (!amount) return '0.00';
      return parseFloat(amount).toFixed(2);
    }

    function showEmptyState(type) {
      if (type === 'expenses') {
        const tbody = document.getElementById('reportsData');
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <i class="fas fa-chart-bar"></i>
              <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
            </td>
          </tr>
        `;
      } else {
        const container = document.querySelector('#maintenanceContent .task-inner-cards');
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-clipboard-list"></i>
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é</p>
          </div>
        `;
      }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
          const tabId = this.dataset.tab + 'Content';
          document.getElementById(tabId).classList.add('active');
          
          loadReports(this.dataset.tab);
        });
      });

      // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
      document.getElementById('applyFilters').addEventListener('click', function() {
        const activeTab = document.querySelector('.tab-button.active').dataset.tab;
        loadReports(activeTab);
      });
      
      // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
      document.getElementById('resetFilters').addEventListener('click', function() {
        document.querySelectorAll('.filter-select').forEach(select => {
          Array.from(select.options).forEach(option => {
            option.selected = false;
          });
        });
        const activeTab = document.querySelector('.tab-button.active').dataset.tab;
        loadReports(activeTab);
      });
      
      // –≠–∫—Å–ø–æ—Ä—Ç PDF
      document.querySelector('.action-btn.pdf').addEventListener('click', function() {
        const activeTab = document.querySelector('.tab-button.active').dataset.tab;
        exportAllReports(activeTab, 'pdf');
      });
      
      // –≠–∫—Å–ø–æ—Ä—Ç Excel
      document.querySelector('.action-btn.excel').addEventListener('click', function() {
        const activeTab = document.querySelector('.tab-button.active').dataset.tab;
        exportAllReports(activeTab, 'excel');
      });
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç—á–µ—Ç–∞–º–∏
    function viewReport(type, reportId) {
      alert(`–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–∞ ${type} #${reportId}`);
    }

    function exportReport(type, reportId) {
      alert(`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞ ${type} #${reportId}`);
    }

    function exportAllReports(type, format) {
      alert(`–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤ ${type} –≤ ${format.toUpperCase()}`);
    }

  </script>
</body>
</html>