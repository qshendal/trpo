<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ ‚Äî –û—Ç—á—ë—Ç—ã</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='Reports.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .log-block { margin-top:10px; padding:10px; border:1px solid #ccc; background:#fafafa; }
  </style>

</head>
<body>
  <div class="container">
    <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
    <aside class="sidebar">
      <h1 class="logo">üîß –¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h1>
      <p class="subtitle">–û—Ç—á—ë—Ç—ã</p>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-alt"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-boxes"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-cog"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã</a></li>
        </ul>
      </nav>
    </aside>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <main class="dashboard">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
      <header class="top-bar">
        <h2>–û—Ç—á—ë—Ç—ã</h2>
        <div class="export-buttons">
          <button class="export-btn pdf"><i class="fas fa-file-pdf"></i> PDF</button>
          <button class="export-btn excel"><i class="fas fa-file-excel"></i> Excel</button>
        </div>
      </header>

      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
      <div class="tabs-wrapper">
        <button class="tab-button active" data-tab="expenses">
          <i class="fas fa-money-bill-wave"></i> –ó–∞—Ç—Ä–∞—Ç—ã
        </button>
        <button class="tab-button" data-tab="maintenance">
          <i class="fas fa-clipboard-check"></i> –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
        </button>
      </div>

      <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <div class="filters-panel">
        <div class="filters-row">
          <!-- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ -->
          <div class="filter-group">
            <label for="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</label>
            <select id="equipment" class="filter-select" multiple size="8">
              <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </select>
          </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∑–∞—Ç—Ä–∞—Ç -->
        <div class="tab-content active" id="expenses">
          <div class="filters">
            <label>–ù–∞—á–∞–ª–æ: <input type="date" id="startDate"></label>
            <label>–ö–æ–Ω–µ—Ü: <input type="date" id="endDate"></label>
            <button onclick="loadExpenses()"><i class="fas fa-filter"></i> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>

          <div id="reportBlock" style="display:none;">
            <table class="report-table" id="expensesTable">
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="export-buttons">
              <button onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
              <button onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>
          </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è -->
        <div class="tab-content" id="maintenance">
          <div class="filters">
            <label>–ù–∞—á–∞–ª–æ: <input type="date" id="maintStart"></label>
            <label>–ö–æ–Ω–µ—Ü: <input type="date" id="maintEnd"></label>
            <button onclick="loadMaintenance()"><i class="fas fa-filter"></i> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>

          <div id="maintenanceBlock" style="display:none;">
            <table class="report-table" id="maintenanceTable">
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                  <th>–§–ò–û</th>
                  <th>–î–µ—Ç–∞–ª—å</th>
                  <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                  <th>–ú–∞—Å—Ç–µ—Ä</th>
                  <th>–ò—Å—Ç–æ—Ä–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="export-buttons">
              <button onclick="exportMaintenanceExcel()"><i class="fas fa-file-excel"></i> Excel</button>
              <button onclick="exportMaintenancePDF()"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

<script>
  // ===== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ =====
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(btn.dataset.mode).classList.add('active');
    });
  });

  // ====== –ó–ê–¢–†–ê–¢–´ ======
  function loadExpenses() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (!start || !end) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥!"); return; }

    fetch(`/api/expenses-by-day?start=${start}&end=${end}`)
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector('#expensesTable tbody');
        tbody.innerHTML = "";
        let total = 0;
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${row.date}</td><td>${row.amount}</td>`;
          tbody.appendChild(tr);
          total += parseFloat(row.amount);
        });
        const trTotal = document.createElement('tr');
        trTotal.innerHTML = `<td><b>–ò—Ç–æ–≥–æ</b></td><td><b>${total}</b></td>`;
        tbody.appendChild(trTotal);
        document.getElementById('reportBlock').style.display = "block";
      });
  }

  function exportToExcel() {
    let table = document.getElementById("expensesTable");
    let html = table.outerHTML;
    let blob = new Blob(["\ufeff" + html], { type: "application/vnd.ms-excel;charset=utf-8" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'expenses_report.xls';
    a.click();
  }

  function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFont("Times", "normal");
    doc.text("–û—Ç—á—ë—Ç –ø–æ –∑–∞—Ç—Ä–∞—Ç–∞–º", 10, 10);
    let rows = [];
    document.querySelectorAll("#expensesTable tbody tr").forEach(tr => {
      let cells = tr.querySelectorAll("td");
      rows.push([cells[0].innerText, cells[1].innerText]);
    });
    doc.autoTable({ head: [['–î–∞—Ç–∞', '–°—É–º–º–∞']], body: rows });
    doc.save("expenses_report.pdf");
  }

  // ====== –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï ======
  function loadMaintenance() {
    const start = document.getElementById('maintStart').value;
    const end = document.getElementById('maintEnd').value;
    if (!start || !end) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥!"); return; }

    fetch(`/api/maintenance-report?start=${start}&end=${end}`)
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector('#maintenanceTable tbody');
        tbody.innerHTML = "";
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.dataset.id = row.request_id; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º id –≤ –∞—Ç—Ä–∏–±—É—Ç
          tr.innerHTML = `
            <td>${row.date}</td>
            <td>${row.client}</td>
            <td>${row.contact_person}</td>
            <td>${row.parts}</td>
            <td>${row.amount}</td>
            <td>${row.technician}</td>
            <td><button onclick="showLog(${row.request_id})">–ò—Å—Ç–æ—Ä–∏—è</button></td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('maintenanceBlock').style.display = "block";
      });
  }

  function exportMaintenanceExcel() {
    let table = document.getElementById("maintenanceTable");
    let html = table.outerHTML;
    let blob = new Blob(["\ufeff" + html], { type: "application/vnd.ms-excel;charset=utf-8" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'maintenance_report.xls';
    a.click();
  }

  function exportMaintenancePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFont("Times", "normal");
    doc.text("–û—Ç—á—ë—Ç –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é", 10, 10);
    let rows = [];
    document.querySelectorAll("#maintenanceTable tbody tr").forEach(tr => {
      let cells = tr.querySelectorAll("td");
      rows.push([
        cells[0].innerText, // –¥–∞—Ç–∞
        cells[1].innerText, // –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
        cells[2].innerText, // —Ñ–∏–æ
        cells[3].innerText, // –¥–µ—Ç–∞–ª—å
        cells[4].innerText, // —Å—Ç–æ–∏–º–æ—Å—Ç—å
        cells[5].innerText  // –º–∞—Å—Ç–µ—Ä
      ]);
    });
    doc.autoTable({ head: [['–î–∞—Ç–∞', '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è', '–§–ò–û', '–î–µ—Ç–∞–ª—å', '–°—Ç–æ–∏–º–æ—Å—Ç—å', '–ú–∞—Å—Ç–µ—Ä']], body: rows });
    doc.save("maintenance_report.pdf");
  }

  // ====== –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π ======
  function showLog(requestId) {
    if (!requestId) {
      alert("–ù–µ—Ç ID –∑–∞—è–≤–∫–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏");
      return;
    }
    fetch(`/api/work-log/${requestId}`)
      .then(res => {
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏");
        return res.json();
      })
      .then(logs => {
        let block = document.createElement('div');
        block.className = "log-block";
        if (!logs || logs.length === 0) {
          block.innerHTML = "<p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.</p>";
        } else {
          let html = "<h4>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h4><ul>";
          logs.forEach(l => {
            html += `<li><b>${l.–¥–∞—Ç–∞}</b>: ${l.–æ–ø–∏—Å–∞–Ω–∏–µ}${l.–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ? " ‚Äî " + l.–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å : ""}</li>`;
          });
          html += "</ul>";
          block.innerHTML = html;
        }
        const row = document.querySelector(`#maintenanceTable tbody tr[data-id="${requestId}"]`);
        if (row) {
          row.after(block);
        }
      })
      .catch(err => console.error(err));
  }
</script>
</body>
</html>