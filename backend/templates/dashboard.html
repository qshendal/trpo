<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NEXUS ‚Äî –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='Dashboard.css') }}">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <h1 class="logo">üîß NEXUS</h1>
        <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
      </div>
      <nav class="menu">
        <ul>
          <li class="active"><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-th-large"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-check"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-database"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-shield"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-line"></i> –û—Ç—á—ë—Ç—ã</a></li>
        </ul>
      </nav>
    </aside>

    <main class="dashboard">
      <header class="top-bar">
        <div class="header-title">
          <h2>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
          <p id="currentDate">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è</p>
        </div>
        <div class="user-profile">
        </div>
      </header>

      <section class="task-section">
        <div class="task-box stat-blue">
          <div class="task-info">
            <div class="task-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</div>
            <div class="task-count" id="activeCount">0</div>
          </div>
          <div class="box-icon-wrap"><i class="fas fa-wrench task-icon"></i></div>
        </div>

        <div class="task-box stat-orange">
          <div class="task-info">
            <div class="task-title">–ú–∞–ª—ã–µ –∑–∞–ø–∞—Å—ã</div>
            <div class="task-count" id="lowStockCount">0</div>
          </div>
          <div class="box-icon-wrap"><i class="fas fa-box-open task-icon"></i></div>
        </div>

        <div class="task-box stat-green">
          <div class="task-info">
            <div class="task-title">–†–∞—Å—Ö–æ–¥—ã (–º–µ—Å)</div>
            <div class="task-count" id="monthlyExpenses">0</div>
          </div>
          <div class="box-icon-wrap"><i class="fas fa-money-bill-wave task-icon"></i></div>
        </div>

        <div class="task-box stat-blue-light">
          <div class="task-info">
            <div class="task-title">–ú–∞—Å—Ç–µ—Ä–∞</div>
            <div class="task-count" id="technicianCount">0</div>
          </div>
          <div class="box-icon-wrap"><i class="fas fa-user-cog task-icon"></i></div>
        </div>
      </section>

      <section class="task-section main-content-grid">
        <div class="task-box task-full">
          <div class="task-header">
            <div class="task-title"><i class="fas fa-tasks"></i> –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</div>
          </div>
          <div class="task-inner-cards" id="maintenanceTasks">
            </div>
        </div>

        <div class="task-box task-full">
          <div class="task-header">
            <div class="task-title"><i class="fas fa-exclamation-circle"></i> –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
            <button class="action-btn" onclick="window.location.href='/client/equipment-registry'">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º</button>
          </div>
          <div class="task-inner-cards" id="lowStockAlerts">
            </div>
        </div>
      </section>
    </main>
  </div>
  <script>
  // –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞—á–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
  function addTaskCard({ name, type, deadline, priorityText, priorityClass }) {
    const card = document.createElement('div');
    card.className = 'task-subcard';

    const left = document.createElement('div');
    left.className = 'task-subcard-left';

    const nameEl = document.createElement('div');
    nameEl.className = 'task-name';
    nameEl.textContent = name;
    left.appendChild(nameEl);

    const typeEl = document.createElement('div');
    typeEl.className = 'task-type';
    typeEl.textContent = type;
    left.appendChild(typeEl);

    const deadlineEl = document.createElement('div');
    deadlineEl.className = 'task-deadline';
    deadlineEl.textContent = deadline;
    left.appendChild(deadlineEl);

    const right = document.createElement('div');
    right.className = 'task-subcard-right';

    const priorityBlock = document.createElement('div');
    priorityBlock.className = `task-priority ${priorityClass}`;
    priorityBlock.textContent = priorityText;
    right.appendChild(priorityBlock);

    card.appendChild(left);
    card.appendChild(right);

    document.getElementById('maintenanceTasks').appendChild(card);
  }

  // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–∫–ª–∞–¥–∞
  function addStockCard({ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ø–æ—Ä–æ–≥ }) {
    const card = document.createElement('div');
    card.className = 'task-subcard low-stock';

    const left = document.createElement('div');
    left.className = 'task-subcard-left';

    const nameEl = document.createElement('div');
    nameEl.className = 'task-name';
    nameEl.textContent = –Ω–∞–∑–≤–∞–Ω–∏–µ;
    left.appendChild(nameEl);

    const currentEl = document.createElement('div');
    currentEl.className = 'task-type';
    currentEl.textContent = `–¢–µ–∫—É—â–∏–π –∑–∞–ø–∞—Å: ${–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ}`;
    left.appendChild(currentEl);

    const minimumEl = document.createElement('div');
    minimumEl.className = 'task-deadline';
    minimumEl.textContent = `–ú–∏–Ω–∏–º—É–º: ${–ø–æ—Ä–æ–≥}`;
    left.appendChild(minimumEl);

    card.appendChild(left);
    document.getElementById('lowStockAlerts').appendChild(card);
  }

  // === –ó–∞–ø—Ä–æ—Å—ã –∫ API ===

  // –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
  fetch('/api/active-requests')
    .then(res => res.json())
    .then(tasks => {
      tasks.forEach(task => addTaskCard(task));
    });

  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
  fetch('/api/active-count')
    .then(res => res.json())
    .then(data => {
      document.getElementById('activeCount').textContent = data.count;
    });

  // –ú–∞–ª—ã–µ –∑–∞–ø–∞—Å—ã
  fetch('/api/low-stock')
    .then(res => res.json())
    .then(parts => {
      document.getElementById('lowStockCount').textContent = parts.length;
      parts.forEach(part => addStockCard(part));
    });

  // –†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü
  fetch('/api/monthly-expenses')
    .then(res => res.json())
    .then(data => {
      document.getElementById('monthlyExpenses').textContent = data.total;
    });

  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Å—Ç–µ—Ä–æ–≤
  fetch('/api/technician-count')
    .then(res => res.json())
    .then(data => {
      document.getElementById('technicianCount').textContent = data.count;
    });
</script>

</body>
</html>