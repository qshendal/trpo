<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ ‚Äî –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='equipment.css') }}">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h1 class="logo">üîß –¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h1>
      <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏</p>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-alt"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-boxes"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-cog"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã</a></li>
        </ul>
      </nav>
    </aside>
    <main class="dashboard">
      <header class="top-bar">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏</h2>
        <button id="openPartModal" class="action-btn"><i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å</button>
      </header>

      <div id="partsContainer" class="parts-list"></div>
    </main>
  </div>

  <div id="partModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <span class="modal-close" id="closePartModal">&times;</span>
      <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –¥–µ—Ç–∞–ª—å</h2>
      <div class="modal-content">
        <label for="partName">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
        <input type="text" id="partName" required>

        <label for="partCode">–ê—Ä—Ç–∏–∫—É–ª:</label>
        <input type="text" id="partCode" required>

        <label for="partPrice">–¶–µ–Ω–∞:</label>
        <input type="number" step="0.01" id="partPrice" required>
        <span class="error-msg" id="priceError"></span>

        <label for="partQuantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
        <input type="number" id="partQuantity" required>
        <span class="error-msg" id="quantityError"></span>

        <label for="partThreshold">–ü–æ—Ä–æ–≥ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
        <input type="number" id="partThreshold" required>
        <span class="error-msg" id="thresholdError"></span>

        <div class="modal-actions">
          <button id="savePartBtn" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("partModalOverlay");
    const openBtn = document.getElementById("openPartModal");
    const closeBtn = document.getElementById("closePartModal");
    const saveBtn = document.getElementById("savePartBtn");
    const modalTitle = document.getElementById("modalTitle");

    let editingPartId = null;

    openBtn.addEventListener("click", () => {
      editingPartId = null;
      clearModal();
      modalTitle.textContent = "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –¥–µ—Ç–∞–ª—å";
      modal.classList.remove("hidden");
    });

    closeBtn.addEventListener("click", () => {
      clearModal();
      modal.classList.add("hidden");
    });

    function clearModal() {
      document.querySelectorAll("#partModalOverlay input").forEach(input => input.value = "");
      document.querySelectorAll(".error-msg").forEach(span => span.textContent = "");
      document.querySelectorAll("input").forEach(input => input.classList.remove("invalid"));
    }

    function setupLiveValidation(inputId, errorId) {
      const input = document.getElementById(inputId);
      const error = document.getElementById(errorId);

      input.addEventListener("input", () => {
        const raw = input.value.trim();
        const value = parseFloat(raw);

        if (raw === "") {
          input.classList.remove("invalid");
          error.textContent = "";
          return;
        }

        if (isNaN(value) || value < 0) {
          input.classList.add("invalid");
          error.textContent = "–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0";
        } else {
          input.classList.remove("invalid");
          error.textContent = "";
        }
      });
    }

    setupLiveValidation("partPrice", "priceError");
    setupLiveValidation("partQuantity", "quantityError");
    setupLiveValidation("partThreshold", "thresholdError");

    saveBtn.addEventListener("click", () => {
      const price = parseFloat(document.getElementById("partPrice").value || 0);
      const quantity = parseInt(document.getElementById("partQuantity").value || 0);
      const threshold = parseInt(document.getElementById("partThreshold").value || 0);

      let hasError = false;
      if (price < 0 || quantity < 0 || threshold < 0) hasError = true;

      if (hasError) {
        alert("–¶–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –ø–æ—Ä–æ–≥ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0.");
        return;
      }

      const payload = {
        –Ω–∞–∑–≤–∞–Ω–∏–µ: document.getElementById("partName").value,
        –∞—Ä—Ç–∏–∫—É–ª: document.getElementById("partCode").value,
        —Ü–µ–Ω–∞: price,
        –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: quantity,
        –ø–æ—Ä–æ–≥: threshold
      };

      const url = editingPartId
        ? `/api/update-part/${editingPartId}`
        : "/api/add-part";

      fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(() => {
        editingPartId = null;
        clearModal();
        modal.classList.add("hidden");
        loadParts();
      }).catch(err => {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏");
        console.error(err);
      });
    });

    function loadParts() {
      const container = document.getElementById("partsContainer");
      container.innerHTML = "";

      fetch("/api/parts")
        .then(res => res.json())
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = "<p>–ù–∞ —Å–∫–ª–∞–¥–µ –Ω–µ—Ç –¥–µ—Ç–∞–ª–µ–π.</p>";
            return;
          }

          data.forEach(part => {
            const card = document.createElement("div");
            card.className = "part-card";
            if (part.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ < part.–ø–æ—Ä–æ–≥) {
              card.classList.add("low-stock");
            }

            card.innerHTML = `
              <h3>${part.–Ω–∞–∑–≤–∞–Ω–∏–µ}</h3>
              <p>–ê—Ä—Ç–∏–∫—É–ª: ${part.–∞—Ä—Ç–∏–∫—É–ª || "‚Äî"}</p>
              <p>–¶–µ–Ω–∞: ${part.—Ü–µ–Ω–∞} Br</p>
              <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${part.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ}</p>
              <div class="part-actions">
                <button class="info-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `;

            card.querySelector(".delete-btn").addEventListener("click", () => {
              if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –¥–µ—Ç–∞–ª—å?")) {
                fetch(`/api/delete-part/${part.id}`, { method: "POST" })
                  .then(() => loadParts())
                  .catch(() => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏"));
              }
            });

            card.querySelector(".info-btn").addEventListener("click", () => {
              editingPartId = part.id;

              document.getElementById("partName").value = part.–Ω–∞–∑–≤–∞–Ω–∏–µ;
              document.getElementById("partCode").value = part.–∞—Ä—Ç–∏–∫—É–ª || "";
              document.getElementById("partPrice").value = part.—Ü–µ–Ω–∞;
              document.getElementById("partQuantity").value = part.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ;
              document.getElementById("partThreshold").value = part.–ø–æ—Ä–æ–≥;

              document.querySelectorAll(".error-msg").forEach(span => span.textContent = "");
              document.querySelectorAll("input").forEach(input => input.classList.remove("invalid"));

              modalTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å";
              modal.classList.remove("hidden");
            });

            container.appendChild(card);
          });
        });
    }
    loadParts();
  });
</script>
</body>
</html>
