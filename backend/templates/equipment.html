<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NEXUS ‚Äî –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='equipment.css') }}">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <h1 class="logo">üîß NEXUS</h1>
        <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
      </div>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-th-large"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-check"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
          <li class="active"><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-database"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-shield"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-line"></i> –û—Ç—á—ë—Ç—ã</a></li>
          <hr style="margin: 20px 0; border: 0; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <li class="logout-item">
              <a href="{{ url_for('admin.logout') }}" class="logout-link" style="color: #fda4af !important;">
                <i class="fas fa-sign-out-alt"></i> <span>–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</span>
              </a>
            </li>
        </ul>
      </nav>
    </aside>

    <main class="dashboard">
      <header class="top-bar">
        <div class="header-title">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏</h2>
          <p>–ö–æ–Ω—Ç—Ä–æ–ª—å –∑–∞–ø—á–∞—Å—Ç–µ–π –∏ —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
        </div>
        <button id="openPartModal" class="action-btn">
          <i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å
        </button>
      </header>

      <div id="partsContainer" class="request-cards"></div>
    </main>
  </div>

  <div id="partModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <div class="modal-header">
        <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –¥–µ—Ç–∞–ª—å</h2>
        <span class="modal-close" id="closePartModal">&times;</span>
      </div>
      
      <div class="modal-content">
        <div class="info-group">
          <label for="partName">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</label>
          <input type="text" id="partName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." required>
        </div>

        <div class="info-group">
          <label for="partCode">–ê—Ä—Ç–∏–∫—É–ª</label>
          <input type="text" id="partCode" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 6204-2Z" required>
        </div>

        <div class="form-row">
          <div class="input-block">
            <label for="partPrice">–¶–µ–Ω–∞ (Br)</label>
            <input type="number" step="0.01" id="partPrice" placeholder="0.00" required>
            <span class="error-msg" id="priceError"></span>
          </div>
          <div class="input-block">
            <label for="partQuantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
            <input type="number" id="partQuantity" placeholder="0" required>
            <span class="error-msg" id="quantityError"></span>
          </div>
        </div>

        <div class="info-group" style="margin-top: 20px;">
          <label for="partThreshold">–ü–æ—Ä–æ–≥ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</label>
          <input type="number" id="partThreshold" placeholder="–£–≤–µ–¥–æ–º–∏—Ç—å, –µ—Å–ª–∏ –º–µ–Ω—å—à–µ..." required>
          <span class="error-msg" id="thresholdError"></span>
        </div>
      </div>

      <div class="modal-actions">
        <button id="savePartBtn" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      </div>
    </div>
  </div>

<script>
  /* JS –û–°–¢–ê–í–õ–ï–ù –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô, –¢–û–õ–¨–ö–û –û–ë–ù–û–í–õ–ï–ù–ê –í–ï–†–°–¢–ö–ê –ö–ê–†–¢–û–ß–ö–ò –í–ù–£–¢–†–ò loadParts */
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("partModalOverlay");
    const openBtn = document.getElementById("openPartModal");
    const closeBtn = document.getElementById("closePartModal");
    const saveBtn = document.getElementById("savePartBtn");
    const modalTitle = document.getElementById("modalTitle");

    let editingPartId = null;

    openBtn.addEventListener("click", () => {
      editingPartId = null;
      clearModal();
      modalTitle.textContent = "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –¥–µ—Ç–∞–ª—å";
      modal.classList.remove("hidden");
    });

    closeBtn.addEventListener("click", () => {
      clearModal();
      modal.classList.add("hidden");
    });

    function clearModal() {
      document.querySelectorAll("#partModalOverlay input").forEach(input => input.value = "");
      document.querySelectorAll(".error-msg").forEach(span => span.textContent = "");
      document.querySelectorAll("input").forEach(input => input.classList.remove("invalid"));
    }

    function setupLiveValidation(inputId, errorId) {
      const input = document.getElementById(inputId);
      const error = document.getElementById(errorId);

      input.addEventListener("input", () => {
        const raw = input.value.trim();
        const value = parseFloat(raw);

        if (raw === "") {
          input.classList.remove("invalid");
          error.textContent = "";
          return;
        }

        if (isNaN(value) || value < 0) {
          input.classList.add("invalid");
          error.textContent = "–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0";
        } else {
          input.classList.remove("invalid");
          error.textContent = "";
        }
      });
    }

    setupLiveValidation("partPrice", "priceError");
    setupLiveValidation("partQuantity", "quantityError");
    setupLiveValidation("partThreshold", "thresholdError");

saveBtn.addEventListener("click", () => {
  // 1. –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
  const nameInput = document.getElementById("partName");
  const codeInput = document.getElementById("partCode");
  const priceInput = document.getElementById("partPrice");
  const quantityInput = document.getElementById("partQuantity");
  const thresholdInput = document.getElementById("partThreshold");

  // 2. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
  document.querySelectorAll(".modal-content input").forEach(input => input.classList.remove("invalid"));

  // 3. –°—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
  const name = nameInput.value.trim();
  const code = codeInput.value.trim();
  const priceRaw = priceInput.value.trim();
  const quantityRaw = quantityInput.value.trim();
  const thresholdRaw = thresholdInput.value.trim();

  // 4. –ü–†–û–í–ï–†–ö–ê –ù–ê –ü–£–°–¢–´–ï –ü–û–õ–Ø
  let emptyFields = [];
  if (!name) emptyFields.push(nameInput);
  if (!code) emptyFields.push(codeInput);
  if (priceRaw === "") emptyFields.push(priceInput);
  if (quantityRaw === "") emptyFields.push(quantityInput);
  if (thresholdRaw === "") emptyFields.push(thresholdInput);

  if (emptyFields.length > 0) {
    emptyFields.forEach(input => input.classList.add("invalid"));
    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã.");
    return;
  }

  // 5. –ü–†–û–í–ï–†–ö–ê –ù–ê –ß–ò–°–õ–û–í–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø
  const price = parseFloat(priceRaw);
  const quantity = parseInt(quantityRaw);
  const threshold = parseInt(thresholdRaw);

  if (isNaN(price) || price < 0 || isNaN(quantity) || quantity < 0 || isNaN(threshold) || threshold < 0) {
    alert("–¶–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –ø–æ—Ä–æ–≥ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏.");
    return;
  }

  // 6. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–• –ò –û–¢–ü–†–ê–í–ö–ê
  const payload = {
    –Ω–∞–∑–≤–∞–Ω–∏–µ: name,
    –∞—Ä—Ç–∏–∫—É–ª: code,
    —Ü–µ–Ω–∞: price,
    –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: quantity,
    –ø–æ—Ä–æ–≥: threshold
  };

  const url = editingPartId
    ? `/api/update-part/${editingPartId}`
    : "/api/add-part";

  fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).then(res => {
    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
    editingPartId = null;
    clearModal();
    modal.classList.add("hidden");
    loadParts();
  }).catch(err => {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏");
    console.error(err);
  });
});
    function loadParts() {
      const container = document.getElementById("partsContainer");
      container.innerHTML = "";

      fetch("/api/parts")
        .then(res => res.json())
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = "<p>–ù–∞ —Å–∫–ª–∞–¥–µ –Ω–µ—Ç –¥–µ—Ç–∞–ª–µ–π.</p>";
            return;
          }

          data.forEach(part => {
            const card = document.createElement("div");
            card.className = "request-card"; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –∫–ª–∞—Å—Å –∏–∑ Plane.css
            if (part.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ < part.–ø–æ—Ä–æ–≥) {
              card.style.borderLeft = "4px solid var(--danger)";
            }

            // –í–µ—Ä—Å—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –µ–¥–∏–Ω–æ–º —Å—Ç–∏–ª–µ —Å Planning
            card.innerHTML = `
              <h3>${part.–Ω–∞–∑–≤–∞–Ω–∏–µ}</h3>
              <div class="request-meta">
                <div class="meta-row"><i class="fas fa-barcode"></i> –ê—Ä—Ç–∏–∫—É–ª: ${part.–∞—Ä—Ç–∏–∫—É–ª || "‚Äî"}</div>
                <div class="meta-row"><i class="fas fa-tag"></i> –¶–µ–Ω–∞: ${part.—Ü–µ–Ω–∞} Br</div>
                <div class="meta-row"><i class="fas fa-layer-group"></i> –û—Å—Ç–∞—Ç–æ–∫: ${part.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ} —à—Ç.</div>
              </div>
              <div class="calendar-actions">
                <button class="info-btn action-btn"><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="delete-btn icon-btn-danger"><i class="fas fa-trash"></i></button>
              </div>
            `;

            card.querySelector(".delete-btn").addEventListener("click", () => {
              if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –¥–µ—Ç–∞–ª—å?")) {
                fetch(`/api/delete-part/${part.id}`, { method: "POST" })
                  .then(() => loadParts())
                  .catch(() => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏"));
              }
            });

            card.querySelector(".info-btn").addEventListener("click", () => {
              editingPartId = part.id;
              document.getElementById("partName").value = part.–Ω–∞–∑–≤–∞–Ω–∏–µ;
              document.getElementById("partCode").value = part.–∞—Ä—Ç–∏–∫—É–ª || "";
              document.getElementById("partPrice").value = part.—Ü–µ–Ω–∞;
              document.getElementById("partQuantity").value = part.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ;
              document.getElementById("partThreshold").value = part.–ø–æ—Ä–æ–≥;
              modalTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å";
              modal.classList.remove("hidden");
            });

            container.appendChild(card);
          });
        });
    }
    loadParts();
  });
</script>
</body>
</html>