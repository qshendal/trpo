<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEXUS ‚Äî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='TO.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">
        <div class="logo-avatar">üìù</div>
        NEXUS<span>FORM</span>
      </div>
      <button id="navBackBtn" class="nav-btn secondary">
        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
      </button>
    </div>
  </nav>

  <div class="main-content form-page-wrapper">
    <div class="form-card">
      <div class="form-header">
        <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏</h2>
        <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–∑–æ–≤–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</p>
      </div>

      <form class="nexus-form" method="POST" action="{{ url_for('client.create_request') }}">
        <input type="hidden" id="categoryField" name="category_tag" value="general">       
         <div class="form-section">
          <h3><i class="fas fa-user-tie"></i> –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞</h3>
          
          <div class="input-grid">
            <div class="input-group">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
              <input type="text" name="company" placeholder="–û–û–û –ó–∞—Ä—è" required>
            </div>
            
            <div class="input-group">
              <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
              <input type="text" name="contact" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò." required>
            </div>
          </div>

          <div class="input-grid">
            <div class="input-group">
              <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
              <input type="tel" name="phone" placeholder="+375 () 000-00-00" required>
            </div>
            <div class="input-group">
              <label>Email</label>
              <input type="email" name="email" placeholder="mail@example.com" required>
            </div>
          </div>

          <div class="input-group full">
            <label>–ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞</label>
            <input type="text" name="address" placeholder="–≥. –ú–∏–Ω—Å–∫, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 32" required>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fas fa-cogs"></i> –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h3>
          
          <div class="input-grid">
            <div class="input-group">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
              <input type="text" name="equipment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–∞–Ω–æ–∫ –ß–ü–£ Model X" required>
            </div>
            <div class="input-group">
              <label>–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</label>
              <input type="date" name="install_date">
            </div>
          </div>

          <div class="input-grid">
            <div class="input-group">
              <label>–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–¶–µ—Ö/–û—Ç–¥–µ–ª)</label>
              <input type="text" name="location" placeholder="–¶–µ—Ö ‚Ññ3">
            </div>
            <div class="input-group">
              <label>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</label>
              <div class="select-wrapper">
                <select name="equipment_status">
                  <option value="–≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏">–í —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏</option>
                  <option value="–Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ" selected>–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–æ</option>
                  <option value="–≤ —Ä–µ–º–æ–Ω—Ç–µ">–í —Ä–µ–º–æ–Ω—Ç–µ</option>
                  <option value="–≤—ã–≤–µ–¥–µ–Ω–æ –∏–∑ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏">–í—ã–≤–µ–¥–µ–Ω–æ –∏–∑ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fas fa-exclamation-triangle"></i> –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</h3>
          <div class="input-group full">
            <textarea name="problem" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å (–∫–æ–¥ –æ—à–∏–±–∫–∏, –∑–≤—É–∫–∏, —Å–∏–º–ø—Ç–æ–º—ã)..." required></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" id="backBtn" class="action-btn secondary">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
          </button>
          <button type="submit" class="action-btn primary">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—è–≤–∫—É <i class="fas fa-check"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–• ===
    const form = document.querySelector('.nexus-form');
    const field = document.getElementById('categoryField');
    const problemArea = document.querySelector('textarea[name="problem"]');
    
    // –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ URL, –ø–æ—Ç–æ–º –∏–∑ —Å–µ—Å—Å–∏–∏ (—á–µ—Ä–µ–∑ Jinja)
    const params = new URLSearchParams(window.location.search);
    const catFromUrl = params.get('category');
    const catFromSession = "{{ session.get('selected_category', '') }}";

    if (field) {
        field.value = catFromUrl || catFromSession || 'general';
        console.log("üéØ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–∞—è–≤–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–∞–∫:", field.value);
    }

    // === 2. –ú–ê–°–ö–ê –¢–ï–õ–ï–§–û–ù–ê (+375...) ===
    const phoneInput = document.querySelector('input[name="phone"]');
    if (phoneInput) {
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, ''); 
            if (value.startsWith('375')) {
                let x = value.match(/(\d{3})(\d{0,2})(\d{0,3})(\d{0,2})(\d{0,2})/);
                e.target.value = !x[2] ? '+' + x[1] : `+${x[1]} (${x[2]}) ${x[3]}` + (x[4] ? `-${x[4]}` : '') + (x[5] ? `-${x[5]}` : '');
            }
        });
    }

    // === 3. –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –î–ê–¢–´ (–ù–ï –ë–£–î–£–©–ï–ï) ===
    const dateInput = document.querySelector('input[name="install_date"]');
    if (dateInput) {
        dateInput.setAttribute('max', new Date().toISOString().split('T')[0]);
    }

    // === 4. –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ù–ê–ó–ê–î) ===
    const role = "{{ session.get('role', 'guest') }}";
    const entryUrl = "{{ url_for('auth.entry_point') }}";
    const userUrl = "{{ url_for('client.user_panel') }}";

    window.goBack = function() {
        window.location.href = (role === "guest") ? entryUrl : userUrl;
    };

    document.getElementById('backBtn')?.addEventListener('click', goBack);
    document.getElementById('navBackBtn')?.addEventListener('click', goBack);

    // === 5. –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–ü–†–ê–í–ö–ò –ò –°–ö–õ–ï–ô–ö–ê –¢–ï–ì–ê ===
    form.addEventListener('submit', function(e) {
        let isValid = true;
        const submitBtn = this.querySelector('button[type="submit"]');
        const requiredFields = this.querySelectorAll('[required]');

        // –ê) –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π
        requiredFields.forEach(f => {
            if (!f.value.trim()) {
                isValid = false;
                f.style.borderColor = '#ef4444';
                f.classList.add('error-shake');
                setTimeout(() => f.classList.remove('error-shake'), 500);
            } else {
                f.style.borderColor = '#e2e8f0';
            }
        });

        // –ë) –í–∞–ª–∏–¥–∞—Ü–∏—è Email
        const email = this.querySelector('input[type="email"]');
        if (email?.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
            isValid = false;
            email.style.borderColor = '#ef4444';
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email');
        }

        // –í) –ì–õ–ê–í–ù–´–ô –®–ê–ì: –°–∫–ª–µ–π–∫–∞ —Ç–µ–≥–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        if (isValid && problemArea && field) {
            const currentTag = field.value.toLowerCase().trim();
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ
            if (!problemArea.value.includes(`[${currentTag}]`)) {
                problemArea.value = `${problemArea.value.trim()} [${currentTag}]`;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        } else if (!isValid) {
            e.preventDefault(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
        }
    });
});
</script>
</body>
</html>