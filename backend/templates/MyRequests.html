<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NEXUS ‚Äî –ó–∞—è–≤–∫–∏</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='Requests.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">
        <div class="logo-avatar">üîó</div>
        NEXUS<span>TASKS</span> 
      </div>
      <a href="{{ url_for('client.user_panel') }}" class="nav-btn secondary">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</a>
    </div>
  </nav>

  <div class="main-content requests-page">
    <div class="page-header">
      <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</h2>
    </div>

    <div class="kanban-board">
      <div class="kanban-column">
        <div class="column-header pending">
          <span class="dot"></span> –í –æ–∂–∏–¥–∞–Ω–∏–∏
        </div>
        <div id="pendingRequests" class="request-list">
          </div>
      </div>

      <div class="kanban-column">
        <div class="column-header progress">
          <span class="dot"></span> –í —Ä–∞–±–æ—Ç–µ
        </div>
        <div id="inProgressRequests" class="request-list"></div>
      </div>

      <div class="kanban-column">
        <div class="column-header payment">
          <span class="dot"></span> –û–ø–ª–∞—Ç–∞
        </div>
        <div id="paymentRequests" class="request-list"></div>
      </div>
    </div>
  </div>

  <div id="paymentModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <div class="modal-header">
        <h3>–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥–∏</h3>
        <span class="modal-close" onclick="document.getElementById('paymentModalOverlay').classList.add('hidden')">&times;</span>
      </div>
      
      <div class="modal-content">
        <div class="bill-info">
          <div class="bill-row">
            <span>–£—Å–ª—É–≥–∞</span>
            <strong id="modalTaskName"></strong>
          </div>
          <div class="bill-row">
            <span>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</span>
            <span id="modalTaskExecutor"></span>
          </div>
          <div class="bill-total">
            <span>–ö –æ–ø–ª–∞—Ç–µ:</span>
            <h2 id="modalTaskCost">0 ‚ÇΩ</h2>
          </div>
        </div>
        
        <span id="modalTaskDeadline" style="display:none"></span>
        <span id="modalTaskDescription" style="display:none"></span>

        <hr class="divider">
        
        <label class="input-label">–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã <span id="modalCardType" class="card-type-badge"></span></label>
        
        <div class="credit-card-form">
          <div class="input-group full">
            <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" maxlength="19">
            <span class="icon">üí≥</span>
          </div>
          <div class="row-inputs">
            <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
            <input type="text" id="cardCVC" placeholder="CVC" maxlength="3">
          </div>
        </div>

        <button id="confirmPaymentBtn" class="action-btn primary full-width">–û–ø–ª–∞—Ç–∏—Ç—å —Å—á–µ—Ç</button>
      </div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const pendingContainer = document.getElementById("pendingRequests");
    const inProgressContainer = document.getElementById("inProgressRequests");
    const paymentContainer = document.getElementById("paymentRequests");

    // --- –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ ---
    const createCardHTML = (task, showExecutor, showPayBtn) => {
      return `
        <div class="request-card-item">
          <div class="card-top">
            <span class="card-id">#${task.id || 'ID'}</span>
            <span class="card-date">${task.deadline || '–ë–µ–∑ –¥–∞—Ç—ã'}</span>
          </div>
          <h4>${task.name}</h4>
          <p class="desc">${task.description}</p>
          ${showExecutor ? `<div class="executor-badge">üë§ ${task.executor}</div>` : ''}
          ${showPayBtn ? `<button class="pay-btn-small" onclick='openPaymentModal(${JSON.stringify(task)})'>–û–ø–ª–∞—Ç–∏—Ç—å</button>` : ''}
        </div>
      `;
    };

    // --- –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –æ–ø–ª–∞—Ç—ã ---
    window.openPaymentModal = function(task) {
      const modalName = document.getElementById("modalTaskName");
      modalName.textContent = task.name || "";
      modalName.dataset.requestId = task.id;
      
      document.getElementById("modalTaskDeadline").textContent = task.deadline || "";
      document.getElementById("modalTaskDescription").textContent = task.description || "";
      document.getElementById("modalTaskExecutor").textContent = task.executor || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
      document.getElementById("modalTaskCost").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

      fetch(`/api/request-cost/${task.id}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("modalTaskCost").textContent = (data.total || 0) + " ‚ÇΩ";
        })
        .catch(() => {
          document.getElementById("modalTaskCost").textContent = "–û—à–∏–±–∫–∞ —Ü–µ–Ω—ã";
        });

      document.getElementById("paymentModalOverlay").classList.remove("hidden");
    };

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–∞ ---
    fetch("/api/my-requests")
      .then(response => {
        if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
        return response.json();
      })
      .then(data => {
        pendingContainer.innerHTML = ""; 
        inProgressContainer.innerHTML = ""; 
        paymentContainer.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          pendingContainer.innerHTML = "<div class='empty-state'>–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>";
          return;
        }

        data.forEach(task => {
          const status = task.type.toLowerCase();
          const el = document.createElement('div');
          
          if (status === "–Ω–æ–≤–∞—è" || status === "–≤ –æ–∂–∏–¥–∞–Ω–∏–∏") {
        el.innerHTML = createCardHTML(task, false, false);
        pendingContainer.appendChild(el);
    } 
    else if (status === "–≤ —Ä–∞–±–æ—Ç–µ") {
        el.innerHTML = createCardHTML(task, true, false);
        inProgressContainer.appendChild(el);
    } 
    else if (status === "–≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã") {
        el.innerHTML = createCardHTML(task, true, true);
        paymentContainer.appendChild(el);
    }
        });
      })
      .catch(error => {
        console.error(error);
        pendingContainer.innerHTML = "<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</p>";
      });
  });

// --- –í–ê–õ–ò–î–ê–¶–ò–Ø –ö–ê–†–¢–´ (–ê–õ–ì–û–†–ò–¢–ú –õ–£–ù–ê) ---
function validateExpiry(expiryString) {
    const parts = expiryString.split('/');
    if (parts.length !== 2) return false;

    const month = parseInt(parts[0], 10);
    const year = parseInt("20" + parts[1], 10); // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º 25 –≤ 2025

    if (isNaN(month) || isNaN(year)) return false;
    if (month < 1 || month > 12) return false;

    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –≥–æ–¥ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ –ò–õ–ò (–≥–æ–¥ —Ç–µ–∫—É—â–∏–π –∏ –º–µ—Å—è—Ü –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ)
    if (year < currentYear || (year === currentYear && month < currentMonth)) {
        return "expired"; // –ö–∞—Ä—Ç–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞
    }

    return true; // –í—Å–µ –æ–∫
}
function getCardType(cardNumber) {
    const value = cardNumber.replace(/\D/g, "");
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –ø–µ—Ä–≤—ã–º —Ü–∏—Ñ—Ä–∞–º
    if (/^4/.test(value)) return "Visa";
    if (/^5[1-5]/.test(value) || /^2(2[2-9]|[3-6]|7[01]|720)/.test(value)) return "MasterCard";
    if (/^220[0-4]/.test(value)) return "–ú–ò–†";
    return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞";
}
// --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –í–í–û–î–ê ---
// --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –í–í–û–î–ê ---
const cardNumberInput = document.getElementById("cardNumber");
const cardExpiryInput = document.getElementById("cardExpiry");
const cardCVCInput = document.getElementById("cardCVC");
const confirmBtn = document.getElementById("confirmPaymentBtn");

if (cardNumberInput) {
    cardNumberInput.addEventListener("input", (e) => {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 16) value = value.substring(0, 16);
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ 0000 0000 0000 0000
        let formatted = value.match(/.{1,4}/g);
        e.target.value = formatted ? formatted.join(" ") : value;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–∞—Ä—Ç—ã
        const typeEl = document.getElementById("modalCardType");
        if (typeEl) {
            typeEl.textContent = getCardType(value);
            typeEl.style.color = (typeEl.textContent === "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞") ? "gray" : "#2563eb";
        }
    });
}

if (cardExpiryInput) {
    cardExpiryInput.addEventListener("input", (e) => {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 4) value = value.substring(0, 4);
        
        if (value.length >= 2) {
            e.target.value = value.substring(0, 2) + "/" + value.substring(2);
        } else {
            e.target.value = value;
        }
    });
}

// --- –§–ò–ù–ê–õ–¨–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï ---
if (confirmBtn) {
    confirmBtn.onclick = function() {
        const btn = this;
        const cardNumberRaw = cardNumberInput.value.replace(/\D/g, "");
        const expiryValue = cardExpiryInput.value.trim();
        const cvcValue = cardCVCInput.value.replace(/\D/g, "");
        
        const cardType = getCardType(cardNumberRaw);
        if (cardType === "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞") {
            alert("–û—à–∏–±–∫–∞: –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—Ä—Ç—É –ú–ò–†, Visa –∏–ª–∏ MasterCard.");
            cardNumberInput.focus();
            return;
        }
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞ (—Ä–æ–≤–Ω–æ 16)
        if (cardNumberRaw.length !== 16) {
            alert("–û—à–∏–±–∫–∞: –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 16 —Ü–∏—Ñ—Ä.");
            cardNumberInput.focus();
            return;
        }

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã
        const expiryStatus = validateExpiry(expiryValue);
        if (expiryStatus === false) {
            alert("–û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ú–ú/–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 05/26).");
            cardExpiryInput.focus();
            return;
        } else if (expiryStatus === "expired") {
            alert("–û–ø–ª–∞—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞: –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç—ã –∏—Å—Ç–µ–∫.");
            return;
        }

        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ CVC (3 —Ü–∏—Ñ—Ä—ã)
        if (cvcValue.length < 3) {
            alert("–û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ 3 —Ü–∏—Ñ—Ä—ã CVC –∫–æ–¥–∞ –Ω–∞ –æ–±–æ—Ä–æ—Ç–µ.");
            cardCVCInput.focus();
            return;
        }

        // –ï—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
        const requestId = document.getElementById("modalTaskName").dataset.requestId;
        btn.disabled = true;
        btn.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";

        fetch(`/api/pay-request/${requestId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                cardNumber: cardNumberRaw, 
                cardExpiry: expiryValue, 
                cardCVC: cvcValue 
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!");
                location.reload(); 
            } else {
                alert("–û—à–∏–±–∫–∞: " + (data.error || "–ü–ª–∞—Ç–µ–∂ –æ—Ç–∫–ª–æ–Ω–µ–Ω –±–∞–Ω–∫–æ–º"));
                btn.disabled = false;
                btn.textContent = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É";
            }
        })
        .catch(() => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            btn.disabled = false;
        });
    };
}
</script>
</body>
</html>