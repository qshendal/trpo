
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–∏ –∑–∞—è–≤–∫–∏</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='Requests.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="requests-wrapper">
    <h2>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h2>

    <a href="{{ url_for('client.user_panel') }}" class="back-button">
      ‚Üê –ù–∞–∑–∞–¥
    </a>

    <div class="status-block">
      <h3 class="status-title">üïì –í –æ–∂–∏–¥–∞–Ω–∏–∏</h3>
      <div id="pendingRequests" class="request-list"></div>
    </div>

    <div class="status-block">
      <h3 class="status-title">üîß –í —Ä–∞–±–æ—Ç–µ</h3>
      <div id="inProgressRequests" class="request-list"></div>
    </div>

    <div class="status-block">
      <h3 class="status-title">üí∞ –í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã</h3>
      <div id="paymentRequests" class="request-list"></div>
    </div>
  </div>

  <div id="paymentModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <span class="modal-close" onclick="document.getElementById('paymentModalOverlay').classList.add('hidden')">&times;</span>
      <h2>–û–ø–ª–∞—Ç–∞ –∑–∞—è–≤–∫–∏</h2>
      <div class="modal-content">
        <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> <span id="modalTaskName"></span></p>
        <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> <span id="modalTaskDeadline"></span></p>
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span id="modalTaskDescription"></span></p>
        <p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> <span id="modalTaskExecutor"></span></p>
        <p><strong>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</strong> <span id="modalTaskCost"></span> —Ä—É–±.</p>
        <p><strong>–¢–∏–ø –∫–∞—Ä—Ç—ã:</strong> <span id="modalCardType"></span></p>
        <hr>
        <label>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã:</label>
        <div class="card-form">
          <input type="text" id="cardNumber" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã" maxlength="19">
          <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
          <input type="text" id="cardCVC" placeholder="CVC" maxlength="3">
        </div>
        <div class="modal-actions">
          <button id="confirmPaymentBtn" class="action-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const pendingContainer = document.getElementById("pendingRequests");
      const inProgressContainer = document.getElementById("inProgressRequests");
      const paymentContainer = document.getElementById("paymentRequests");

      fetch("/api/my-requests")
        .then(response => {
          if (!response.ok) {
            throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + response.status);
          }
          return response.json();
        })
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) {
            pendingContainer.innerHTML = "<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫.</p>";
            inProgressContainer.innerHTML = "";
            paymentContainer.innerHTML = "";
            return;
          }

          pendingContainer.innerHTML = "";
          inProgressContainer.innerHTML = "";
          paymentContainer.innerHTML = "";

          data.forEach(task => {
            const status = task.type.toLowerCase();

            const card = document.createElement("div");
            card.className = "request-card";
            card.innerHTML = `
              <h3>${task.name}</h3>
              <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${task.type}</p>
              <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> ${task.deadline}</p>
              <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${task.description}</p>
              ${status !== "–Ω–æ–≤–∞—è" && status !== "–≤ –æ–∂–∏–¥–∞–Ω–∏–∏"
                ? `<p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> ${task.executor || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"}</p>`
                : ""}
            `;

            if (status === "–Ω–æ–≤–∞—è" || status === "–≤ –æ–∂–∏–¥–∞–Ω–∏–∏") {
              pendingContainer.appendChild(card);
            } else if (status === "–≤ —Ä–∞–±–æ—Ç–µ") {
              inProgressContainer.appendChild(card);
            } else if (status === "–≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã") {
              const payBtn = document.createElement("button");
              payBtn.className = "action-btn";
              payBtn.textContent = "–û–ø–ª–∞—Ç–∏—Ç—å";
              payBtn.onclick = () => openPaymentModal(task);
              card.appendChild(payBtn);

              paymentContainer.appendChild(card);
            }
          });
        })
        .catch(error => {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫:", error);
          pendingContainer.innerHTML = "<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>";
          inProgressContainer.innerHTML = "";
          paymentContainer.innerHTML = "";
        });
    });

    function openPaymentModal(task) {
      document.getElementById("modalTaskName").textContent = task.name || "";
      document.getElementById("modalTaskName").dataset.requestId = task.id;
      document.getElementById("modalTaskDeadline").textContent = task.deadline || "";
      document.getElementById("modalTaskDescription").textContent = task.description || "";
      document.getElementById("modalTaskExecutor").textContent = task.executor || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";

      fetch(`/api/request-cost/${task.id}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("modalTaskCost").textContent = data.total || 0;
        })
        .catch(() => {
          document.getElementById("modalTaskCost").textContent = "–û—à–∏–±–∫–∞";
        });

      document.getElementById("paymentModalOverlay").classList.remove("hidden");
    }

    function getCardType(cardNumber) {
      if (/^4/.test(cardNumber)) return "Visa";
      if (/^5[1-5]/.test(cardNumber)) return "MasterCard";
      if (/^2(2[2-9]|[3-6]|7[01]|720)/.test(cardNumber)) return "MasterCard";
      return "";
    }

    const cardNumberInput = document.getElementById("cardNumber");
    cardNumberInput.addEventListener("input", () => {
      let value = cardNumberInput.value.replace(/\D/g, ""); 
      value = value.substring(0, 16); 
      let formatted = value.match(/.{1,4}/g);
      cardNumberInput.value = formatted ? formatted.join(" ") : "";

      const cardType = getCardType(value);
      document.getElementById("modalCardType").textContent = cardType;
    });

    const cardExpiryInput = document.getElementById("cardExpiry");
    cardExpiryInput.addEventListener("input", () => {
      let value = cardExpiryInput.value.replace(/\D/g, ""); 
      value = value.substring(0, 4); 

      if (value.length >= 3) {
        cardExpiryInput.value = value.substring(0, 2) + "/" + value.substring(2);
      } else {
        cardExpiryInput.value = value;
      }
    });

    document.getElementById("confirmPaymentBtn").addEventListener("click", () => {
      const cardNumberRaw = cardNumberInput.value.replace(/\s/g, "");
      const cardExpiry = document.getElementById("cardExpiry").value.trim();
      const cardCVC = document.getElementById("cardCVC").value.trim();

      if (!/^\d{16}$/.test(cardNumberRaw)) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (16 —Ü–∏—Ñ—Ä).");
        return;
      }
      if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(cardExpiry)) {
        alert("–í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YY.");
        return;
      }
      if (!/^\d{3}$/.test(cardCVC)) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π CVC (3 —Ü–∏—Ñ—Ä—ã).");
        return;
      }

      const cardType = getCardType(cardNumberRaw);
      if (!cardType) {
        alert("–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ Visa –∏–ª–∏ MasterCard.");
        return;
      }

      const requestId = document.getElementById("modalTaskName").dataset.requestId;

      fetch(`/api/pay-request/${requestId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cardNumber: cardNumberRaw, cardExpiry, cardCVC })
      })
        .then(res => {
          if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã");
          return res.json();
        })
        .then(data => {
          if (data.success) {
            alert(`–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –¢–∏–ø –∫–∞—Ä—Ç—ã: ${cardType}`);
            document.getElementById("paymentModalOverlay").classList.add("hidden");
            location.reload();
          } else {
            alert("–û—à–∏–±–∫–∞: " + data.error);
          }
        })
        .catch(err => {
          alert("–û—à–∏–±–∫–∞: " + err.message);
        });
    });
  </script>
</body>
</html>
