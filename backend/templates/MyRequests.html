<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NEXUS ‚Äî –ó–∞—è–≤–∫–∏</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='Requests.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">
        <div class="logo-avatar">üîó</div>
        NEXUS<span>TASKS</span> 
      </div>
      <a href="{{ url_for('client.user_panel') }}" class="nav-btn secondary">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</a>
    </div>
  </nav>

  <div class="main-content requests-page">
    <div class="page-header">
      <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</h2>
    </div>

    <div class="kanban-board">
      <div class="kanban-column">
        <div class="column-header pending">
          <span class="dot"></span> –í –æ–∂–∏–¥–∞–Ω–∏–∏
        </div>
        <div id="pendingRequests" class="request-list">
          </div>
      </div>

      <div class="kanban-column">
        <div class="column-header progress">
          <span class="dot"></span> –í —Ä–∞–±–æ—Ç–µ
        </div>
        <div id="inProgressRequests" class="request-list"></div>
      </div>

      <div class="kanban-column">
        <div class="column-header payment">
          <span class="dot"></span> –û–ø–ª–∞—Ç–∞
        </div>
        <div id="paymentRequests" class="request-list"></div>
      </div>
    </div>
  </div>

  <div id="paymentModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <div class="modal-header">
        <h3>–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥–∏</h3>
        <span class="modal-close" onclick="document.getElementById('paymentModalOverlay').classList.add('hidden')">&times;</span>
      </div>
      
      <div class="modal-content">
        <div class="bill-info">
          <div class="bill-row">
            <span>–£—Å–ª—É–≥–∞</span>
            <strong id="modalTaskName"></strong>
          </div>
          <div class="bill-row">
            <span>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</span>
            <span id="modalTaskExecutor"></span>
          </div>
          <div class="bill-total">
            <span>–ö –æ–ø–ª–∞—Ç–µ:</span>
            <h2 id="modalTaskCost">0 ‚ÇΩ</h2>
          </div>
        </div>
        
        <span id="modalTaskDeadline" style="display:none"></span>
        <span id="modalTaskDescription" style="display:none"></span>

        <hr class="divider">
        
        <label class="input-label">–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã <span id="modalCardType" class="card-type-badge"></span></label>
        
        <div class="credit-card-form">
          <div class="input-group full">
            <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" maxlength="19">
            <span class="icon">üí≥</span>
          </div>
          <div class="row-inputs">
            <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
            <input type="text" id="cardCVC" placeholder="CVC" maxlength="3">
          </div>
        </div>

        <button id="confirmPaymentBtn" class="action-btn primary full-width">–û–ø–ª–∞—Ç–∏—Ç—å —Å—á–µ—Ç</button>
      </div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const pendingContainer = document.getElementById("pendingRequests");
    const inProgressContainer = document.getElementById("inProgressRequests");
    const paymentContainer = document.getElementById("paymentRequests");

    // --- –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ ---
    const createCardHTML = (task, showExecutor, showPayBtn) => {
      return `
        <div class="request-card-item">
          <div class="card-top">
            <span class="card-id">#${task.id || 'ID'}</span>
            <span class="card-date">${task.deadline || '–ë–µ–∑ –¥–∞—Ç—ã'}</span>
          </div>
          <h4>${task.name}</h4>
          <p class="desc">${task.description}</p>
          ${showExecutor ? `<div class="executor-badge">üë§ ${task.executor}</div>` : ''}
          ${showPayBtn ? `<button class="pay-btn-small" onclick='openPaymentModal(${JSON.stringify(task)})'>–û–ø–ª–∞—Ç–∏—Ç—å</button>` : ''}
        </div>
      `;
    };

    // --- –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –æ–ø–ª–∞—Ç—ã ---
    window.openPaymentModal = function(task) {
      const modalName = document.getElementById("modalTaskName");
      modalName.textContent = task.name || "";
      modalName.dataset.requestId = task.id;
      
      document.getElementById("modalTaskDeadline").textContent = task.deadline || "";
      document.getElementById("modalTaskDescription").textContent = task.description || "";
      document.getElementById("modalTaskExecutor").textContent = task.executor || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
      document.getElementById("modalTaskCost").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

      fetch(`/api/request-cost/${task.id}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("modalTaskCost").textContent = (data.total || 0) + " ‚ÇΩ";
        })
        .catch(() => {
          document.getElementById("modalTaskCost").textContent = "–û—à–∏–±–∫–∞ —Ü–µ–Ω—ã";
        });

      document.getElementById("paymentModalOverlay").classList.remove("hidden");
    };

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–∞ ---
    fetch("/api/my-requests")
      .then(response => {
        if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
        return response.json();
      })
      .then(data => {
        pendingContainer.innerHTML = ""; 
        inProgressContainer.innerHTML = ""; 
        paymentContainer.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          pendingContainer.innerHTML = "<div class='empty-state'>–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>";
          return;
        }

        data.forEach(task => {
          const status = task.type.toLowerCase();
          const el = document.createElement('div');
          
          if (status === "–Ω–æ–≤–∞—è" || status === "–≤ –æ–∂–∏–¥–∞–Ω–∏–∏") {
        el.innerHTML = createCardHTML(task, false, false);
        pendingContainer.appendChild(el);
    } 
    else if (status === "–≤ —Ä–∞–±–æ—Ç–µ") {
        el.innerHTML = createCardHTML(task, true, false);
        inProgressContainer.appendChild(el);
    } 
    else if (status === "–≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã") {
        el.innerHTML = createCardHTML(task, true, true);
        paymentContainer.appendChild(el);
    }
        });
      })
      .catch(error => {
        console.error(error);
        pendingContainer.innerHTML = "<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</p>";
      });
  });

// --- –í–ê–õ–ò–î–ê–¶–ò–Ø –ö–ê–†–¢–´ (–ê–õ–ì–û–†–ò–¢–ú –õ–£–ù–ê) ---
function validateLuhn(number) {
    let sum = 0;
    let shouldDouble = false;
    // –û—á–∏—â–∞–µ–º –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–ø–∞–ª–∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
    const sanitized = number.replace(/\D/g, "");
    for (let i = sanitized.length - 1; i >= 0; i--) {
        let digit = parseInt(sanitized.charAt(i));
        if (shouldDouble) {
            if ((digit *= 2) > 9) digit -= 9;
        }
        sum += digit;
        shouldDouble = !shouldDouble;
    }
    return (sum % 10) === 0 && sanitized.length > 0;
}

function getCardType(cardNumber) {
    const value = cardNumber.replace(/\D/g, "");
    if (/^4/.test(value)) return "Visa";
    if (/^5[1-5]/.test(value) || /^2(2[2-9]|[3-6]|7[01]|720)/.test(value)) return "MasterCard";
    if (/^220[0-4]/.test(value)) return "–ú–ò–†";
    return "";
}
// --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –í–í–û–î–ê ---
// –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤–µ–∑–¥–µ
const cardNumberInput = document.getElementById("cardNumber");
const cardExpiryInput = document.getElementById("cardExpiry");
const cardCVCInput = document.getElementById("cardCVC");
const confirmBtn = document.getElementById("confirmPaymentBtn");

if (cardNumberInput) {
    cardNumberInput.addEventListener("input", (e) => {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 16) value = value.substring(0, 16);
        let formatted = value.match(/.{1,4}/g);
        e.target.value = formatted ? formatted.join(" ") : value;
        const typeEl = document.getElementById("modalCardType");
        if (typeEl && typeof getCardType === "function") typeEl.textContent = getCardType(value);
    });
}

if (cardExpiryInput) {
    cardExpiryInput.addEventListener("input", (e) => {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 4) value = value.substring(0, 4);
        if (value.length > 2) {
            e.target.value = value.substring(0, 2) + "/" + value.substring(2);
        } else {
            e.target.value = value;
        }
    });
}
// --- –§–ò–ù–ê–õ–¨–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–ü–õ–ê–¢–´ ---
if (confirmBtn) {
    confirmBtn.onclick = function() {
        const btn = this;
        
        // 1. –ü–û–õ–£–ß–ê–ï–ú –†–ï–ê–õ–¨–ù–´–ô ID –ó–ê–Ø–í–ö–ò (–∏–∑ dataset –º–æ–¥–∞–ª–∫–∏)
        // –≠—Ç–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª—Å—è —Å—Ç–∞—Ç—É—Å –∏–º–µ–Ω–Ω–æ –ù–£–ñ–ù–û–ô –∫–∞—Ä—Ç–æ—á–∫–∏
        const requestId = document.getElementById("modalTaskName").dataset.requestId;

        const rawInput = document.getElementById("cardNumber").value;
        const cardNumberRaw = rawInput.replace(/\D/g, "");

        if (cardNumberRaw.length < 16) {
            alert("–û—à–∏–±–∫–∞: –≤–≤–µ–¥–∏—Ç–µ 16 —Ü–∏—Ñ—Ä –∫–∞—Ä—Ç—ã.");
            return;
        }

        const cardExpiry = document.getElementById("cardExpiry").value.trim();
        const cardCVC = document.getElementById("cardCVC").value.replace(/\D/g, "");

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        btn.disabled = true;
        btn.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        fetch(`/api/pay-request/${requestId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                cardNumber: cardNumberRaw, // –®–ª–µ–º –†–ï–ê–õ–¨–ù–´–ô –Ω–æ–º–µ—Ä
                cardExpiry: cardExpiry, 
                cardCVC: cardCVC 
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // –ü–û–°–õ–ï –≠–¢–û–ì–û –ö–ê–†–¢–û–ß–ö–ê –ò–°–ß–ï–ó–ù–ï–¢
                alert("–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!");
                location.reload(); 
                // –¢.–∫. —Å—Ç–∞—Ç—É—Å –≤ –ë–î —Ç–µ–ø–µ—Ä—å "–æ–ø–ª–∞—á–µ–Ω–æ", 
                // –∞ –≤ —Ç–≤–æ–µ–º —Ü–∏–∫–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –Ω–µ—Ç —É—Å–ª–æ–≤–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞,
                // –∫–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ—Ç—Ä–∏—Å—É–µ—Ç—Å—è.
            } else {
                alert("–û—à–∏–±–∫–∞: " + (data.error || "–∫–æ–¥ 400"));
                btn.disabled = false;
                btn.textContent = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É";
            }
        })
        .catch(err => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            btn.disabled = false;
            btn.textContent = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É";
        });
    };
}
</script>
</body>
</html>