<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NEXUS ‚Äî –ú–∞—Å—Ç–µ—Ä–∞</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='Masters.css') }}">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <h1 class="logo">üîß NEXUS</h1>
        <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
      </div>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-th-large"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-check"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-database"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li class="active"><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-shield"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-line"></i> –û—Ç—á—ë—Ç—ã</a></li>
          <hr style="margin: 20px 0; border: 0; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <li class="logout-item">
              <a href="{{ url_for('admin.logout') }}" class="logout-link" style="color: #fda4af !important;">
                <i class="fas fa-sign-out-alt"></i> <span>–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</span>
              </a>
            </li>
        </ul>
      </nav>
    </aside>

    <main class="dashboard">
      <header class="top-bar">
        <div class="header-title">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º</h2>
          <p>–†–µ–µ—Å—Ç—Ä –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤</p>
        </div>
        <button id="openMasterModal" class="assign-btn">
          <i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞
        </button>
      </header>

      <div id="mastersContainer" class="masters-list"></div>
    </main>
  </div>

  <div id="masterModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <div class="modal-header">
        <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</h2>
        <span class="modal-close" id="closeMasterModal">&times;</span>
      </div>
      
      <div class="modal-content">
        <div class="info-group">
          <label for="masterName">–§–ò–û –º–∞—Å—Ç–µ—Ä–∞</label>
          <input type="text" id="masterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è..." required>
        </div>

<div class="info-group">
  <label for="masterSpecialty">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</label>
  <div class="select-wrapper">
   <select id="masterSpecialty" required>
      <option value="" disabled selected hidden>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</option>
      <option value="energy">–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ (Energy)</option>
      <option value="mechanic">–ú–µ—Ö–∞–Ω–∏–∫–∞ (Mechanic)</option>
      <option value="robotics">–†–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∞ (Robotics)</option>
      <option value="digital">Digital-—Å–∏—Å—Ç–µ–º—ã (Digital)</option>
      <option value="fluid">–ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞ –∏ –ø–Ω–µ–≤–º–∞—Ç–∏–∫–∞ (Fluid)</option>
      <option value="it">IT-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (IT)</option>
</select>
    <i class="fas fa-chevron-down select-icon"></i>
  </div>
</div>
        <div class="info-group">
          <label for="assignNumber">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="text" id="assignNumber" placeholder="+375 (__) ___-__-__" required>
        </div>

        <div class="info-group">
          <label for="masterComment">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
          <textarea id="masterComment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button id="saveMasterBtn" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    let editingMasterId = null;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const modal = document.getElementById("masterModalOverlay");
    const openBtn = document.getElementById("openMasterModal");
    const closeBtn = document.getElementById("closeMasterModal");
    const saveBtn = document.getElementById("saveMasterBtn");
    const container = document.getElementById("mastersContainer");
    const phoneInput = document.getElementById("assignNumber");

    // --- 1. –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –∏–Ω–ø—É—Ç–æ–≤ ---
    function formatPhone(phone) {
        if (!phone) return "‚Äî";
        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 9 —Ü–∏—Ñ—Ä (—Ç–µ–ª–æ –Ω–æ–º–µ—Ä–∞)
        let d = phone.replace(/\D/g, "").slice(-9); 
        
        if (d.length === 9) {
            return `+375 (${d.slice(0, 2)}) ${d.slice(2, 5)}-${d.slice(5, 7)}-${d.slice(7, 9)}`;
        }
        return phone; 
    }

    // --- 2. –ñ–∏–≤–∞—è –º–∞—Å–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –º–æ–¥–∞–ª–∫–µ ---
    phoneInput.addEventListener("input", (e) => {
        let value = e.target.value.replace(/\D/g, "");
        
        // –û—Ç—Å–µ–∫–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –≤–≤–æ–¥–∏—Ç—å –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –≤—Ä—É—á–Ω—É—é
        if (value.startsWith("375")) value = value.slice(3);
        else if (value.startsWith("80")) value = value.slice(2);
        
        value = value.slice(0, 9); // –õ–∏–º–∏—Ç ‚Äî 9 —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞
        
        let result = "";
        if (value.length > 0) result = "+375 (" + value.slice(0, 2);
        if (value.length > 2) result += ") " + value.slice(2, 5);
        if (value.length > 5) result += "-" + value.slice(5, 7);
        if (value.length > 7) result += "-" + value.slice(7, 9);
        
        e.target.value = value ? result : "";
    });

    // –£–±–∏—Ä–∞–µ–º –∫—Ä–∞—Å–Ω—É—é —Ä–∞–º–∫—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≤–≤–æ–¥–∞
    document.querySelectorAll("#masterModalOverlay input").forEach(input => {
        input.addEventListener("input", () => input.classList.remove("invalid"));
    });

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    openBtn.addEventListener("click", () => {
        editingMasterId = null;
        clearModal();
        document.getElementById("modalTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞";
        modal.classList.remove("hidden");
    });

    closeBtn.addEventListener("click", () => modal.classList.add("hidden"));

    function clearModal() {
        document.getElementById("masterName").value = "";
        document.getElementById("masterSpecialty").value = ""; 
        phoneInput.value = "";
        document.getElementById("masterComment").value = "";
        document.querySelectorAll(".invalid").forEach(el => el.classList.remove("invalid"));
    }

    // --- 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ---
    saveBtn.addEventListener("click", async () => {
        const nameInput = document.getElementById("masterName");
        const specialtyInput = document.getElementById("masterSpecialty");
        const commentInput = document.getElementById("masterComment");

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –º–∞—Å–∫–∏ (+375 (XX) XXX-XX-XX = 19 —Å–∏–º–≤–æ–ª–æ–≤)
        const isPhoneValid = phoneInput.value.length === 19;
        const validCodes = ["25", "29", "33", "44"];
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ –∏–∑ –º–∞—Å–∫–∏ (—Å–∏–º–≤–æ–ª—ã –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ 7 –∏ 8 –≤ —Å—Ç—Ä–æ–∫–µ "+375 (XX...")
        const currentCode = phoneInput.value.substring(6, 8);
        const isCodeValid = validCodes.includes(currentCode);
        let hasError = false;
        if (!nameInput.value.trim()) { nameInput.classList.add("invalid"); hasError = true; }
        if (!specialtyInput.value.trim()) { specialtyInput.classList.add("invalid"); hasError = true; }
        if (!isPhoneValid) { phoneInput.classList.add("invalid"); hasError = true; }

        if (hasError) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!");
            return;
        }
        if (!isCodeValid) {
            phoneInput.classList.add("invalid");
            alert("–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞! –î–æ–ø—É—Å—Ç–∏–º—ã —Ç–æ–ª—å–∫–æ 25, 29, 33, 44.");
            return;
        }
        const payload = {
            name: nameInput.value.trim(),
            specialty: specialtyInput.value.trim(),
            phone: phoneInput.value.trim(), // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä
            comment: commentInput.value.trim()
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
        try {
            const response = await fetch("/api/masters");
            const allMasters = await response.json();

            const duplicate = allMasters.find(m => {
                const isSameName = m.name.toLowerCase() === payload.name.toLowerCase();
                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
                const isSamePhone = m.phone.replace(/\D/g, "").slice(-9) === payload.phone.replace(/\D/g, "").slice(-9);
                return (isSameName || isSamePhone) && m.id !== editingMasterId;
            });

            if (duplicate) {
                alert(`–û—à–∏–±–∫–∞: –ú–∞—Å—Ç–µ—Ä —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –∏–ª–∏ –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.`);
                return;
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:", e);
        }

        const url = editingMasterId ? `/api/update-master/${editingMasterId}` : "/api/add-master";
        
        fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
            return res.json();
        })
        .then(() => {
            editingMasterId = null;
            modal.classList.add("hidden");  
            loadMasters(); 
        })
        .catch(err => alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: " + err.message));
    });

    // --- 4. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ ---
    function loadMasters() {
        container.innerHTML = "<p class='loading'>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Ä–µ–µ—Å—Ç—Ä–æ–º...</p>";
        
        const urlParams = new URLSearchParams(window.location.search);
        const recommendTag = urlParams.get('recommend_for')?.toLowerCase(); 

        fetch("/api/masters")
            .then(res => res.json())
            .then(data => {
                container.innerHTML = ""; 

                if (!data || data.length === 0) {
                    container.innerHTML = "<p class='empty-msg'>–†–µ–µ—Å—Ç—Ä –ø—É—Å—Ç.</p>";
                    return;
                }

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –≤—ã—à–µ)
                data.sort((a, b) => {
                    const isARec = recommendTag && (a.specialty || "").toLowerCase().includes(recommendTag);
                    const isBRec = recommendTag && (b.specialty || "").toLowerCase().includes(recommendTag);
                    return isBRec - isARec;
                });

data.forEach(master => {
    const card = document.createElement("div");
    card.className = "master-card";
    
    const isRecommended = recommendTag && (master.specialty || "").toLowerCase().includes(recommendTag);
    if (isRecommended) card.classList.add("recommended-card");

    card.innerHTML = `
        ${isRecommended ? `<div class="recommend-badge"><i class="fas fa-star"></i> –†–ï–ö–û–ú–ï–ù–î–£–ï–ú</div>` : ''}
        <h3>${master.name || "–ë–µ–∑ –∏–º–µ–Ω–∏"}</h3>
        <div class="master-info">
            <div class="info-row"><i class="fas fa-briefcase"></i> <span>${master.specialty || "‚Äî"}</span></div>
            <div class="info-row"><i class="fas fa-phone-alt"></i> <span>${formatPhone(master.phone)}</span></div>
            <div class="info-row"><i class="fas fa-sticky-note"></i> <span>${master.comment || "‚Äî"}</span></div>
            <div class="info-row status-row">
                <i class="fas fa-tasks"></i>
                <span>–ó–∞–≥—Ä—É–∑–∫–∞: <strong class="${master.active_tasks_count >= 3 ? 'text-danger' : ''}">${master.active_tasks_count || 0}/3</strong></span>
            </div>
        </div>
        <div class="master-actions">
            <button class="btn-edit-master">
                <i class="fas fa-pen"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    // –õ–æ–≥–∏–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞)
    card.querySelector(".btn-edit-master").onclick = () => {
        editingMasterId = master.id;
        document.getElementById("masterName").value = master.name;
        document.getElementById("masterSpecialty").value = master.specialty;
        phoneInput.value = formatPhone(master.phone);
        document.getElementById("masterComment").value = master.comment || "";
        document.getElementById("modalTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä–∞";
        modal.classList.remove("hidden");
    };

    // –£–¥–∞–ª–µ–Ω–∏–µ
    card.querySelector(".delete-btn").onclick = () => {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞ ${master.name}?`)) {
            fetch(`/api/delete-master/${master.id}`, { method: "POST" }).then(() => loadMasters());
        }
    };

    container.appendChild(card);
});
            })
            .catch(err => {
                container.innerHTML = `<p class='error-msg'>–û—à–∏–±–∫–∞: ${err.message}</p>`;
            });
    }

    loadMasters();
});
</script>
</body>
</html>