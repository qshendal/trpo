<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ ‚Äî –ú–∞—Å—Ç–µ—Ä–∞</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='Masters.css') }}">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h1 class="logo">üîß –¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h1>
      <p class="subtitle">–ú–∞—Å—Ç–µ—Ä–∞</p>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-alt"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-boxes"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-cog"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã</a></li>
        </ul>
      </nav>
    </aside>

    <main class="dashboard">
      <header class="top-bar">
        <h2>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞</h2>
        <button id="openMasterModal" class="assign-btn"><i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</button>
      </header>

      <div id="mastersContainer" class="masters-list"></div>
    </main>
  </div>

  <div id="masterModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <span class="modal-close" id="closeMasterModal">&times;</span>
      <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</h2>
      <div class="modal-content">
        <label for="masterName">–§–ò–û –º–∞—Å—Ç–µ—Ä–∞:</label>
        <input type="text" id="masterName" required>

        <label for="masterSpecialty">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</label>
        <input type="text" id="masterSpecialty" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —ç–ª–µ–∫—Ç—Ä–∏–∫" required>

        <label for="assignDate">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
        <input type="test" id="assignNumber" required>

        <label for="masterComment">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
        <textarea id="masterComment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"></textarea>

        <div class="modal-actions">
          <button id="saveMasterBtn" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

 <script>
  document.addEventListener("DOMContentLoaded", () => {
    let editingMasterId = null
    const modal = document.getElementById("masterModalOverlay")
    const openBtn = document.getElementById("openMasterModal")
    const closeBtn = document.getElementById("closeMasterModal")
    const saveBtn = document.getElementById("saveMasterBtn")
    const container = document.getElementById("mastersContainer")

    openBtn.addEventListener("click", () => {
      editingMasterId = null
      clearModal()
      document.getElementById("modalTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞"
      modal.classList.remove("hidden")
    })

    closeBtn.addEventListener("click", () => {
      modal.classList.add("hidden")
    })

    window.addEventListener("click", (event) => {
      if (event.target === modal) {
        modal.classList.add("hidden")
      }
    })

    function clearModal() {
      document.getElementById("masterName").value = ""
      document.getElementById("masterSpecialty").value = ""
      document.getElementById("assignNumber").value = ""
      document.getElementById("masterComment").value = ""
    }

    saveBtn.addEventListener("click", () => {
      const payload = {
        name: document.getElementById("masterName").value.trim(),
        specialty: document.getElementById("masterSpecialty").value.trim(),
        phone: document.getElementById("assignNumber").value.trim(),
        comment: document.getElementById("masterComment").value.trim()
      }
      const url = editingMasterId ? `/api/update-master/${editingMasterId}` : "/api/add-master"
      fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(() => {
        editingMasterId = null
        modal.classList.add("hidden")
        loadMasters()
      })
      .catch(err => {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞")
        console.error(err)
      })
    })

    function loadMasters() {
      container.innerHTML = ""
      fetch("/api/masters")
        .then(res => res.json())
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = "<p>–ú–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>"
            return
          }
          data.forEach(master => {
            const card = document.createElement("div")
            card.className = "master-card"
            card.innerHTML = `
              <h3>${master.name}</h3>
              <p>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ${master.specialty}</p>
              <p>–¢–µ–ª–µ—Ñ–æ–Ω: ${master.phone}</p>
              <p>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${master.comment || "‚Äî"}</p>
              <div class="master-actions">
                <button class="info-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `
            card.querySelector(".delete-btn").addEventListener("click", () => {
              if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞?")) {
                fetch(`/api/delete-master/${master.id}`, { method: "POST" })
                  .then(() => loadMasters())
                  .catch(() => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏"))
              }
            })
            card.querySelector(".info-btn").addEventListener("click", () => {
              editingMasterId = master.id
              document.getElementById("masterName").value = master.name
              document.getElementById("masterSpecialty").value = master.specialty
              document.getElementById("assignNumber").value = master.phone
              document.getElementById("masterComment").value = master.comment || ""
              document.getElementById("modalTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä–∞"
              modal.classList.remove("hidden")
            })
            container.appendChild(card)
          })
        })
    }

    loadMasters()
  })
</script>
</body>
</html>
