<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NEXUS ‚Äî –ú–∞—Å—Ç–µ—Ä–∞</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='Masters.css') }}">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <h1 class="logo">üîß NEXUS</h1>
        <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
      </div>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-th-large"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-check"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-database"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li class="active"><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-shield"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-line"></i> –û—Ç—á—ë—Ç—ã</a></li>
        </ul>
      </nav>
    </aside>

    <main class="dashboard">
      <header class="top-bar">
        <div class="header-title">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º</h2>
          <p>–†–µ–µ—Å—Ç—Ä –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤</p>
        </div>
        <button id="openMasterModal" class="assign-btn">
          <i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞
        </button>
      </header>

      <div id="mastersContainer" class="masters-list"></div>
    </main>
  </div>

  <div id="masterModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <div class="modal-header">
        <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</h2>
        <span class="modal-close" id="closeMasterModal">&times;</span>
      </div>
      
      <div class="modal-content">
        <div class="info-group">
          <label for="masterName">–§–ò–û –º–∞—Å—Ç–µ—Ä–∞</label>
          <input type="text" id="masterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è..." required>
        </div>

<div class="info-group">
  <label for="masterSpecialty">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</label>
  <div class="select-wrapper">
   <select id="masterSpecialty" required>
      <option value="" disabled selected hidden>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</option>
      <option value="energy">–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ (Energy)</option>
      <option value="mechanic">–ú–µ—Ö–∞–Ω–∏–∫–∞ (Mechanic)</option>
      <option value="robotics">–†–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∞ (Robotics)</option>
      <option value="digital">Digital-—Å–∏—Å—Ç–µ–º—ã (Digital)</option>
      <option value="fluid">–ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞ –∏ –ø–Ω–µ–≤–º–∞—Ç–∏–∫–∞ (Fluid)</option>
      <option value="it">IT-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (IT)</option>
</select>
    <i class="fas fa-chevron-down select-icon"></i>
  </div>
</div>
        <div class="info-group">
          <label for="assignNumber">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="text" id="assignNumber" placeholder="+375 (__) ___-__-__" required>
        </div>

        <div class="info-group">
          <label for="masterComment">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
          <textarea id="masterComment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button id="saveMasterBtn" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    let editingMasterId = null;
    const modal = document.getElementById("masterModalOverlay");
    const openBtn = document.getElementById("openMasterModal");
    const closeBtn = document.getElementById("closeMasterModal");
    const saveBtn = document.getElementById("saveMasterBtn");
    const container = document.getElementById("mastersContainer");

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    openBtn.addEventListener("click", () => {
        editingMasterId = null;
        clearModal();
        document.getElementById("modalTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞";
        modal.classList.remove("hidden");
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ 
    closeBtn.addEventListener("click", () => {
        modal.classList.add("hidden");
    });

    function clearModal() {
        document.getElementById("masterName").value = "";
        document.getElementById("masterSpecialty").value = ""; 
        document.getElementById("assignNumber").value = "";
        document.getElementById("masterComment").value = "";
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    saveBtn.addEventListener("click", () => {
        const payload = {
            name: document.getElementById("masterName").value.trim(),
            specialty: document.getElementById("masterSpecialty").value.trim(),
            phone: document.getElementById("assignNumber").value.trim(),
            comment: document.getElementById("masterComment").value.trim()
        };

        if (!payload.name || !payload.specialty) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è (–§–ò–û –∏ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)");
            return;
        }

        const url = editingMasterId ? `/api/update-master/${editingMasterId}` : "/api/add-master";
        
        fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
            return res.json();
        })
        .then(() => {
            editingMasterId = null;
            modal.classList.add("hidden");
            loadMasters(); 
        })
        .catch(err => alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: " + err.message));
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞
function loadMasters() {
    container.innerHTML = "<p class='loading'>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Ä–µ–µ—Å—Ç—Ä–æ–º...</p>";
    
    const urlParams = new URLSearchParams(window.location.search);
    const recommendTag = urlParams.get('recommend_for')?.toLowerCase(); 

    fetch("/api/masters")
        .then(res => {
            if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
            return res.json();
        })
        .then(data => {
            container.innerHTML = ""; 

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = "<p class='empty-msg'>–†–µ–µ—Å—Ç—Ä –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞.</p>";
                return;
            }

            // === 1. –°–û–†–¢–ò–†–û–í–ö–ê ===
            // –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞ (—É –∫–æ—Ç–æ—Ä—ã—Ö specialty —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–≥–æ–º) –∏–¥—É—Ç –ø–µ—Ä–≤—ã–º–∏
            data.sort((a, b) => {
                const specA = (a.specialty || "").toLowerCase();
                const specB = (b.specialty || "").toLowerCase();
                const isARec = recommendTag && specA === recommendTag;
                const isBRec = recommendTag && specB === recommendTag;
                return (isBRec === isARec) ? 0 : isARec ? -1 : 1;
            });

            // === 2. –û–¢–†–ò–°–û–í–ö–ê ===
            data.forEach(master => {
                try {
                    const card = document.createElement("div");
                    card.className = "master-card";
                    
                    const masterSpec = (master.specialty || "").toLowerCase();
                    // –ü—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: —Ç–µ–≥ "energy" == —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å "energy"
                    const isRecommended = recommendTag && masterSpec.includes(recommendTag);
                    if (isRecommended) {
                        card.classList.add("recommended-card");
                    }

                    card.innerHTML = `
                        ${isRecommended ? `
                            <div class="recommend-badge">
                                <i class="fas fa-star"></i> –†–ï–ö–û–ú–ï–ù–î–£–ï–ú –î–õ–Ø [${recommendTag.toUpperCase()}]
                            </div>` : ''}
                        <h3>${master.name || "–ë–µ–∑ –∏–º–µ–Ω–∏"}</h3>
                        <div class="master-info">
                            <div class="info-row">
                                <i class="fas fa-briefcase"></i> 
                                <span>${master.specialty || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"}</span>
                            </div>
                            <div class="info-row">
                                <i class="fas fa-phone-alt"></i> 
                                <span>${master.phone || "‚Äî"}</span>
                            </div>
                            <div class="info-row">
                                <i class="fas fa-sticky-note"></i> 
                                <span>${master.comment || "‚Äî"}</span>
                            </div>
                            <div class="info-row status-row">
                                <i class="fas fa-tasks"></i>
                                <span>–ó–∞–≥—Ä—É–∑–∫–∞: <strong class="${(master.active_tasks_count >= 3) ? 'text-danger' : ''}">${master.active_tasks_count || 0}/3</strong></span>
                            </div>
                        </div>
                        <div class="master-actions">
                            <button class="info-btn"><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="delete-btn"><i class="fas fa-trash"></i></button>
                        </div>
                    `;

                    // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π (–£–¥–∞–ª–µ–Ω–∏–µ/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
                    card.querySelector(".delete-btn").addEventListener("click", () => {
                        if (confirm(`–£–¥–∞–ª–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞ ${master.name}?`)) {
                            fetch(`/api/delete-master/${master.id}`, { method: "POST" }).then(() => loadMasters());
                        }
                    });

                    card.querySelector(".info-btn").addEventListener("click", () => {
                        editingMasterId = master.id;
                        document.getElementById("masterName").value = master.name;
                        document.getElementById("masterSpecialty").value = master.specialty;
                        document.getElementById("assignNumber").value = master.phone;
                        document.getElementById("masterComment").value = master.comment || "";
                        document.getElementById("modalTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä–∞";
                        modal.classList.remove("hidden");
                    });

                    container.appendChild(card);
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏:", err);
                }
            });
        })
        .catch(err => {
            container.innerHTML = `<p class='error-msg'>–û—à–∏–±–∫–∞: ${err.message}</p>`;
        });
}
    loadMasters();
});
</script>
</body>
</html>