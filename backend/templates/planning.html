<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='Plane.css') }}">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h1 class="logo">üîß –¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h1>
      <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–æ–π</p>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-alt"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-boxes"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-cog"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã</a></li>
        </ul>
      </nav>
    </aside>
    <main class="dashboard">
      <header class="top-bar">
        <h2>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</h2>
      </header>

      <div class="tabs-wrapper">
        <button class="tab-button active" data-tab="calendar">üìÖ <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
        <button class="tab-button" data-tab="requests">‚ö†Ô∏è <span>–ó–∞—è–≤–∫–∏ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</span></button>
      </div>

      <div class="tab-content active" id="calendar">
        <div class="calendar-section">
          <h3>üîß –í —Ä–∞–±–æ—Ç–µ</h3>
          <div id="calendarTasks" class="calendar-tasks"></div>
        </div>

        <div class="calendar-section">
          <h3>üí∞ –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</h3>
          <div id="awaitingPaymentTasks" class="calendar-tasks"></div>
        </div>

        <div class="calendar-section">
          <h3>‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</h3>
          <div id="completedTasks" class="calendar-tasks"></div>
        </div>
      </div>

      <div class="tab-content" id="requests">
        <div id="requestCards" class="request-cards"></div>
      </div>

    </main>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞—è–≤–∫–µ -->
  <div id="modalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <span class="modal-close">&times;</span>
      <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ</h2>
      <div class="modal-content">
        <p><strong>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</strong> <span id="modalCompany"></span></p>
        <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ:</strong> <span id="modalContact"></span></p>
        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="modalPhone"></span></p>
        <p><strong>Email:</strong> <span id="modalEmail"></span></p>
        <p><strong>–ê–¥—Ä–µ—Å:</strong> <span id="modalAddress"></span></p>
        <hr>
        <p><strong>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</strong> <span id="modalEquipment"></span></p>
        <p><strong>–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</strong> <span id="modalInstallDate"></span></p>
        <p><strong>–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</strong> <span id="modalLocation"></span></p>
        <p><strong>–°—Ç–∞—Ç—É—Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:</strong> <span id="modalEquipmentStatus"></span></p>
        <hr>
        <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> <span id="modalRequestDate"></span></p>
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</strong> <span id="modalProblem"></span></p>
        <p><strong>–ú–µ—Å—Ç–æ —Ä–µ–º–æ–Ω—Ç–∞:</strong> <span id="modalRepairLocation"></span></p>
        <hr>
        <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
        <select id="prioritySelect">
          <option value="">–í—ã–±—Ä–∞—Ç—å</option>
          <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
          <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
          <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
        </select>
        <label>–ú–µ—Å—Ç–æ —Ä–µ–º–æ–Ω—Ç–∞:</label>
        <select id="repairLocationSelect">
          <option value="" disabled selected hidden>–í—ã–±—Ä–∞—Ç—å</option>
          <option value="–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏">–ù–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏</option>
          <option value="–Ω–∞ –±–∞–∑–µ">–ù–∞ –±–∞–∑–µ</option>
        </select>
        <div class="modal-actions">
          <button id="takeInWorkBtn" class="action-btn" disabled>–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
          <button id="deleteBtn" class="icon-btn" title="–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–æ–≤ -->
  <div id="assignModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <span class="modal-close" onclick="document.getElementById('assignModalOverlay').classList.add('hidden')">&times;</span>
      <h2>–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤</h2>
      <div id="mastersList"></div>
      <div class="modal-actions">
        <button id="saveAssignBtn" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π -->
  <div id="partsModalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <span class="modal-close" onclick="document.getElementById('partsModalOverlay').classList.add('hidden')">&times;</span>
      <h2>–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏</h2>
      <div id="partsList"></div>
      <div class="modal-actions">
        <button id="savePartsBtn" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>


<script>
  let currentTask = null;

  const buttons = document.querySelectorAll('.tab-button');
  const contents = document.querySelectorAll('.tab-content');

  function activateTab(target) {
    buttons.forEach(btn => btn.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));
    const activeButton = document.querySelector(`.tab-button[data-tab="${target}"]`);
    const activeContent = document.getElementById(target);
    if (activeButton) activeButton.classList.add('active');
    if (activeContent) activeContent.classList.add('active');
    if (target === "requests") {
      loadRequests();
    } else if (target === "calendar") {
      loadCalendarTasks();
    }
  }

function loadCalendarTasks() {
  fetch('/api/calendar-tasks')
    .then(res => res.json())
    .then(data => {
      // –∞–∫—Ç–∏–≤–Ω—ã–µ
      renderTasks(data.active, document.getElementById("calendarTasks"), "active");
      // –æ–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã (–≤–∫–ª—é—á–∞—è –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ)
      renderTasks(data.awaiting_payment, document.getElementById("awaitingPaymentTasks"), "awaiting_payment");
      // –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ
      if (document.getElementById("completedTasks")) {
        renderTasks(data.completed, document.getElementById("completedTasks"), "completed");
      }
    })
    .catch(() => {
      document.getElementById("calendarTasks").innerHTML = "<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–±–æ—Ç.</p>";
    });
}

function renderTasks(tasks, container, type) {
  container.innerHTML = "";
  if (!Array.isArray(tasks) || tasks.length === 0) {
    container.innerHTML = "<p>–ù–µ—Ç –∑–∞–¥–∞—á.</p>";
    return;
  }

  tasks.forEach(task => {
    const card = document.createElement("div");
    card.className = "calendar-card";
    card.innerHTML = `
      <h3>${task.name}</h3>
      <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> ${task.deadline}</p>
      <p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> ${task.executor || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"}</p>
      <p><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> ${task.priority}</p>
      <p><strong>–ù–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è –¥–µ—Ç–∞–ª—å:</strong> ${
        task.assignedPart
          ? `${task.assignedPart.name} (${task.assignedPart.qty} —à—Ç.)`
          : "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞"
      }</p>
      <div class="calendar-actions"></div>
    `;

    const actions = card.querySelector(".calendar-actions");

    // === –í —Ä–∞–±–æ—Ç–µ ===
    if (type === "active") {
      if (!task.executor) {
        const assignBtn = document.createElement("button");
        assignBtn.className = "assign-btn";
        assignBtn.textContent = "–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞";
        assignBtn.onclick = () => openAssignModal(task);
        actions.appendChild(assignBtn);
      } else {
        const unassignBtn = document.createElement("button");
        unassignBtn.className = "unassign-master-btn";
        unassignBtn.textContent = "–û—Ç–≤—è–∑–∞—Ç—å –º–∞—Å—Ç–µ—Ä–∞";
        unassignBtn.onclick = () => {
          fetch(`/api/unassign-master/${task.id}`, { method: "POST" })
            .then(() => loadCalendarTasks());
        };
        actions.appendChild(unassignBtn);
      }

      if (!task.assignedPart) {
        const partsBtn = document.createElement("button");
        partsBtn.className = "parts-btn";
        partsBtn.textContent = "–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏";
        partsBtn.onclick = () => openPartsModal(task);
        actions.appendChild(partsBtn);
      } else {
        const unassignPartBtn = document.createElement("button");
        unassignPartBtn.className = "unassign-part-btn";
        unassignPartBtn.textContent = "–û—Ç–≤—è–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å";
        unassignPartBtn.onclick = () => {
          fetch(`/api/unassign-part/${task.id}`, { method: "POST" })
            .then(() => loadCalendarTasks());
        };
        actions.appendChild(unassignPartBtn);
      }

      const doneBtn = document.createElement("button");
      doneBtn.className = "done-btn";
      doneBtn.textContent = "–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞";
      doneBtn.onclick = () => {
        if (!task.executor || !task.assignedPart) {
          alert("–ß—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É, –Ω—É–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞ –∏ –¥–µ—Ç–∞–ª—å.");
          return;
        }
        fetch(`/api/complete-task/${task.id}`, { method: "POST" })
          .then(() => loadCalendarTasks());
      };
      actions.appendChild(doneBtn);
    }

    // === –í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã (–≤–∫–ª—é—á–∞—è –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∏ –≥–æ—Å—Ç–µ–≤—ã–µ) ===
    else if (type === "awaiting_payment") {
      const badge = document.createElement("span");
      badge.className = "status-badge awaiting";

      if (task.type === "–æ–ø–ª–∞—á–µ–Ω–æ") {
        badge.textContent = "–û–ø–ª–∞—á–µ–Ω–æ";
      } else {
        badge.textContent = "–í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã";
      }
      actions.appendChild(badge);

      if (task.type === "–æ–ø–ª–∞—á–µ–Ω–æ" || !task.users_id) {
        const finalizeBtn = document.createElement("button");
        finalizeBtn.className = "done-btn";
        finalizeBtn.textContent = "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É";
        finalizeBtn.onclick = () => {
          fetch(`/api/finalize-task/${task.id}`, { method: "POST" })
            .then(() => loadCalendarTasks());
        };
        actions.appendChild(finalizeBtn);
      }
    }

    // === –ó–∞–≤–µ—Ä—à–µ–Ω–∞ ===
    else if (type === "completed") {
      const badge = document.createElement("span");
      badge.className = "status-badge completed";
      badge.textContent = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ";
      actions.appendChild(badge);

      // –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–∏—Ç—å
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "delete-btn";
      deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
      deleteBtn.onclick = () => {
        if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?")) {
          fetch(`/api/delete-task/${task.id}`, { method: "DELETE" })
            .then(() => loadCalendarTasks());
        }
      };
      actions.appendChild(deleteBtn);
    }

    container.appendChild(card);
  });
}


  function loadRequests() {
    const container = document.getElementById("requestCards");
    container.innerHTML = "";
    fetch('/api/new-requests')
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = "<p>–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ.</p>";
          return;
        }
        data.forEach(task => {
          const card = document.createElement("div");
          card.className = "request-card";
          card.innerHTML = `
            <h3>${task.name}</h3>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${task.type}</p>
            <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> ${task.deadline}</p>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${task.description}</p>
          `;
          const button = document.createElement("button");
          button.className = "action-btn";
          button.textContent = "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫—É";
          button.addEventListener("click", () => openModal(task));
          card.appendChild(button);
          container.appendChild(card);
        });
      })
      .catch(() => {
        container.innerHTML = "<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫.</p>";
      });
  }

  function openModal(task) {
    currentTask = task;
    document.getElementById("modalCompany").textContent = task.company || "";
    document.getElementById("modalContact").textContent = task.contact || "";
    document.getElementById("modalPhone").textContent = task.phone || "";
    document.getElementById("modalEmail").textContent = task.email || "";
    document.getElementById("modalAddress").textContent = task.address || "";
    document.getElementById("modalEquipment").textContent = task.equipment || "";
    document.getElementById("modalInstallDate").textContent = task.install_date || "";
    document.getElementById("modalLocation").textContent = task.location || "";
    document.getElementById("modalEquipmentStatus").textContent = task.equipment_status || "";
    document.getElementById("modalRequestDate").textContent = task.deadline || "";
    document.getElementById("modalProblem").textContent = task.description || "";
    document.getElementById("modalRepairLocation").textContent = task.repair_location || "";
    document.getElementById("prioritySelect").value = task.priority || "";
    document.getElementById("repairLocationSelect").value =
      (task.repair_location === "–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏" || task.repair_location === "–Ω–∞ –±–∞–∑–µ")
        ? task.repair_location : "";
    checkActivationReady();
    document.getElementById("modalOverlay").classList.remove("hidden");
  }


  function checkActivationReady() {
    const priority = document.getElementById("prioritySelect").value;
    const location = document.getElementById("repairLocationSelect").value;
    const validPriorities = ["–≤—ã—Å–æ–∫–∏–π", "—Å—Ä–µ–¥–Ω–∏–π", "–Ω–∏–∑–∫–∏–π"];
    const validLocations = ["–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏", "–Ω–∞ –±–∞–∑–µ"];
    document.getElementById("takeInWorkBtn").disabled = !(validPriorities.includes(priority) && validLocations.includes(location));
  }

  document.getElementById("prioritySelect").addEventListener("change", e => {
    fetch(`/api/set-priority/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ priority: e.target.value })
    }).then(checkActivationReady);
  });

  document.getElementById("repairLocationSelect").addEventListener("change", e => {
    fetch(`/api/set-location/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ location: e.target.value })
    }).then(checkActivationReady);
  });

  document.getElementById("takeInWorkBtn").addEventListener("click", () => {
    fetch(`/api/activate-request/${currentTask.id}`, { method: "POST" })
      .then(() => {
        document.getElementById("modalOverlay").classList.add("hidden");
        loadRequests();
      });
  });

  document.getElementById("deleteBtn").addEventListener("click", () => {
    const reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:");
    if (!reason) return;
    fetch(`/api/delete-request/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ reason })
    }).then(() => {
      document.getElementById("modalOverlay").classList.add("hidden");
      loadRequests();
    });
  });

  document.querySelector(".modal-close").addEventListener("click", () => {
    document.getElementById("modalOverlay").classList.add("hidden");
  });

  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const target = button.getAttribute('data-tab');
      activateTab(target);
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    activateTab("calendar");
  });

function openAssignModal(task) {
  currentTask = task;
  const modal = document.getElementById("assignModalOverlay");
  const list = document.getElementById("mastersList");
  list.innerHTML = "";

  // –∑–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤
  fetch("/api/masters")
    .then(res => {
      if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + res.status);
      return res.json();
    })
    .then(data => {
      data.forEach(master => {
        const item = document.createElement("div");
        item.className = "master-item";
        item.innerHTML = `
          <label>
            <input type="checkbox" value="${master.id}">
            ${master.name} ‚Äî ${master.specialty}, ${master.phone}
          </label>
        `;
        list.appendChild(item);
      });
    })
    .catch(err => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Å—Ç–µ—Ä–æ–≤:", err);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤.");
    });

  // —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
  document.getElementById("saveAssignBtn").onclick = () => {
    const selected = Array.from(list.querySelectorAll("input:checked")).map(cb => cb.value);

    fetch(`/api/assign-masters/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ masters: selected })
    })
    .then(res => {
      if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + res.status);
      return res.json();
    })
    .then(data => {
      console.log("–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞:", data);
      modal.classList.add("hidden");
      loadCalendarTasks();
    })
    .catch(err => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞:", err);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
    });
  };

  modal.classList.remove("hidden");
}


function openPartsModal(task) {
  currentTask = task;
  const modal = document.getElementById("partsModalOverlay");
  const list = document.getElementById("partsList");
  list.innerHTML = "";

  fetch("/api/parts_en")
    .then(res => res.json())
    .then(data => {
      data.forEach(part => {
        const item = document.createElement("div");
        item.className = "part-item";
        item.innerHTML = `
          <label>
            <input type="radio" name="partSelect" value="${part.id}">
            ${part.name} ‚Äî ${part.type}, —Ü–µ–Ω–∞: ${part.price}, –¥–æ—Å—Ç—É–ø–Ω–æ: ${part.quantity}
          </label>
        `;
        list.appendChild(item);
      });
    });

function completeTask(id) {
  fetch(`/api/complete-task/${id}`, { method: "POST" })
    .then(res => res.json())
    .then(() => loadCalendarTasks())
    .catch(err => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –≤ –æ–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã:", err);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
    });
}


  document.getElementById("savePartsBtn").onclick = () => {
    const selected = document.querySelector("input[name='partSelect']:checked");
    if (!selected) {
      alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.");
      return;
    }

    fetch(`/api/assign-part/${task.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ part_id: selected.value })
    })
    .then(res => res.json())
    .then(() => {
      modal.classList.add("hidden");
      loadCalendarTasks();
    })
    .catch(err => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏:", err);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –¥–µ—Ç–∞–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
    });
  };

  modal.classList.remove("hidden");
}

</script>

</body>
</html>