<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NEXUS ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='Plane.css') }}">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <h1 class="logo">üîß NEXUS</h1>
        <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
      </div>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-th-large"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li class="active"><a href="{{ url_for('admin.work_planning') }}"><i class="fas fa-calendar-check"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
          <li><a href="{{ url_for('client.equipment_registry') }}"><i class="fas fa-database"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('admin.masters') }}"><i class="fas fa-user-shield"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('admin.reports') }}"><i class="fas fa-chart-line"></i> –û—Ç—á—ë—Ç—ã</a></li>
          <hr style="margin: 20px 0; border: 0; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <li class="logout-item">
              <a href="{{ url_for('admin.logout') }}" class="logout-link" style="color: #fda4af !important;">
                <i class="fas fa-sign-out-alt"></i> <span>–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</span>
              </a>
            </li>
        </ul>
      </nav>
    </aside>

    <main class="dashboard">
      <header class="top-bar">
        <div class="header-title">
          <h2>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</h2>
          <p>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∑–∞—è–≤–æ–∫</p>
        </div>
      </header>

      <div class="tabs-wrapper">
        <button class="tab-button active" data-tab="calendar">
          <i class="fas fa-stream"></i> <span>–•–æ–¥ —Ä–∞–±–æ—Ç</span>
        </button>
        <button class="tab-button" data-tab="requests">
          <i class="fas fa-envelope-open-text"></i> <span>–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏</span>
        </button>
      </div>

<div class="tab-content active" id="calendar">
        <div class="planning-grid">
          <div class="calendar-section">
            <div class="section-header sh-blue">
               <h3><i class="fas fa-tools"></i> –í —Ä–∞–±–æ—Ç–µ</h3>
            </div>
            <div id="calendarTasks" class="calendar-tasks"></div>
          </div>

          <div class="calendar-section">
            <div class="section-header sh-orange">
              <h3><i class="fas fa-file-invoice-dollar"></i> –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</h3>
            </div>
            <div id="awaitingPaymentTasks" class="calendar-tasks"></div>
          </div>

          <div class="calendar-section">
            <div class="section-header sh-green">
              <h3><i class="fas fa-check-double"></i> –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</h3>
            </div>
            <div id="completedTasks" class="calendar-tasks"></div>
          </div>
        </div>

        <div class="task-section history-section">
            <hr style="margin: 40px 0; border: 0; border-top: 1px dashed #cbd5e1;">
            <h2 class="history-title"><i class="fas fa-archive"></i> –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</h2>
            <div id="historyTasks" class="task-grid completed-grid"></div>
        </div>
      </div> <div class="tab-content" id="requests">
        <div id="requestCards" class="request-cards"></div>
      </div>
            <div class="tab-content" id="requests">
        <div id="requestCards" class="request-cards"></div>
      </div>
    </main>
  </div>

  <div id="modal-container">
    <div id="modalOverlay" class="modal-overlay hidden">
      <div class="modal-window">
        <div class="modal-header">
          <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ</h2>
          <span class="modal-close">&times;</span>
        </div>
        <div class="modal-scroll-area">
          <div class="modal-content">
            <div class="info-group">
              <label>–ö–ª–∏–µ–Ω—Ç</label>
              <p><i class="fas fa-building"></i> <span id="modalCompany"></span></p>
              <p><i class="fas fa-user"></i> <span id="modalContact"></span></p>
              <p><i class="fas fa-phone"></i> <span id="modalPhone"></span></p>
            </div>
            <div class="info-group">
              <label>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</label>
              <p><i class="fas fa-microchip"></i> <span id="modalEquipment"></span></p>
              <p><i class="fas fa-map-marker-alt"></i> <span id="modalLocation"></span></p>
            </div>
            <div class="info-group">
              <label>–ü—Ä–æ–±–ª–µ–º–∞</label>
              <p class="problem-desc" id="modalProblem"></p>
            </div>
            <hr>
            <div class="form-row">
              <div class="input-block">
                <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                <select id="prioritySelect">
                  <option value="">–í—ã–±—Ä–∞—Ç—å</option>
                  <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
                  <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
                  <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
                </select>
              </div>
              <div class="input-block">
                <label>–ú–µ—Å—Ç–æ —Ä–µ–º–æ–Ω—Ç–∞:</label>
                <select id="repairLocationSelect">
                  <option value="" disabled selected hidden>–í—ã–±—Ä–∞—Ç—å</option>
                  <option value="–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏">–ù–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏</option>
                  <option value="–Ω–∞ –±–∞–∑–µ">–ù–∞ –±–∞–∑–µ</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button id="deleteBtn" class="icon-btn-danger" title="–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É"><i class="fas fa-trash"></i></button>
          <button id="takeInWorkBtn" class="action-btn" disabled>–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
        </div>
      </div>
    </div>

    <div id="assignModalOverlay" class="modal-overlay hidden">
        <div class="modal-window">
            <div class="modal-header">
                <h2>–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤</h2>
                <span class="modal-close" onclick="document.getElementById('assignModalOverlay').classList.add('hidden')">&times;</span>
            </div>
            <div id="mastersList" class="modal-list"></div>
            <div class="modal-actions">
                <button id="saveAssignBtn" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>

    <div id="partsModalOverlay" class="modal-overlay hidden">
        <div class="modal-window">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç–∏</h2>
                <span class="modal-close" onclick="document.getElementById('partsModalOverlay').classList.add('hidden')">&times;</span>
            </div>
            <div id="partsList" class="modal-list"></div>
            <div class="modal-actions">
                <button id="savePartsBtn" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
  </div>

<script>
  let currentTask = null;

  const buttons = document.querySelectorAll('.tab-button');
  const contents = document.querySelectorAll('.tab-content');

  function activateTab(target) {
    buttons.forEach(btn => btn.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));
    const activeButton = document.querySelector(`.tab-button[data-tab="${target}"]`);
    const activeContent = document.getElementById(target);
    if (activeButton) activeButton.classList.add('active');
    if (activeContent) activeContent.classList.add('active');
    if (target === "requests") {
      loadRequests();
    } else if (target === "calendar") {
      loadCalendarTasks();
    }
  }
const priorityWeight = {
    '–≤—ã—Å–æ–∫–∏–π': 1,
    '—Å—Ä–µ–¥–Ω–∏–π': 2,
    '–Ω–∏–∑–∫–∏–π': 3,
    '–Ω–µ —É–∫–∞–∑–∞–Ω': 4,
    '': 4
};

function sortByPriority(a, b) {
    const weightA = priorityWeight[(a.priority || "").toLowerCase()] || 4;
    const weightB = priorityWeight[(b.priority || "").toLowerCase()] || 4;
    return weightA - weightB;
}
function loadCalendarTasks() {
    fetch('/api/calendar-tasks')
      .then(res => res.json())
      .then(data => {
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
        const sortedActive = (data.active || []).sort(sortByPriority);

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã
        const sortedAwaiting = (data.awaiting_payment || []).sort(sortByPriority);

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
        const sortedCompleted = (data.completed || []).sort(sortByPriority);

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–ø–æ –¥–∞—Ç–µ, —á—Ç–æ–±—ã –∏—Å—Ç–æ—Ä–∏—è –±—ã–ª–∞ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–Ω–∞)
        const sortedArchived = (data.archived || []).sort(
          (a, b) => new Date(b.deadline) - new Date(a.deadline)
        );

        // –†–µ–Ω–¥–µ—Ä–∏–º —Å–µ–∫—Ü–∏–∏
        renderTasks(sortedActive, document.getElementById("calendarTasks"), "active");
        renderTasks(sortedAwaiting, document.getElementById("awaitingPaymentTasks"), "awaiting_payment");
        renderTasks(sortedCompleted, document.getElementById("completedTasks"), "completed");

        const historyContainer = document.getElementById("historyTasks");
        if (historyContainer) {
          renderTasks(sortedArchived, historyContainer, "archived");
        }
      })
      .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:", err));
}

function renderTasks(tasks, container, type) {
    container.innerHTML = "";
    if (!Array.isArray(tasks) || tasks.length === 0) {
      container.innerHTML = "<p>–ù–µ—Ç –∑–∞–¥–∞—á.</p>";
      return;
    }

    tasks.forEach(task => {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
      let priorityClass = 'priority-default';
      const p = (task.priority || "").toLowerCase();
      if (p === '–≤—ã—Å–æ–∫–∏–π') priorityClass = 'priority-high';
      else if (p === '—Å—Ä–µ–¥–Ω–∏–π') priorityClass = 'priority-medium';
      else if (p === '–Ω–∏–∑–∫–∏–π') priorityClass = 'priority-low';

      const card = document.createElement("div");
      card.className = "calendar-card";

      card.innerHTML = `
        <h3>${task.name}</h3>
        <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> ${task.deadline}</p>
        <p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> ${task.executor || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"}</p>
        <p><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> <span class="priority-badge ${priorityClass}">${task.priority || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span></p>
        <p><strong>–î–µ—Ç–∞–ª—å:</strong> ${
          task.assignedPart
            ? `${task.assignedPart.name} (${task.assignedPart.qty} —à—Ç.)`
            : "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞"
        }</p>
        <div class="calendar-actions"></div>
      `;

      const actions = card.querySelector(".calendar-actions");

      // --- –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫ ---
      if (type === "active") {
        if (!task.executor) {
          const assignBtn = document.createElement("button");
          assignBtn.className = "assign-btn";
          assignBtn.textContent = "–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞";
          assignBtn.onclick = () => openAssignModal(task);
          actions.appendChild(assignBtn);
        } else {
          const unassignBtn = document.createElement("button");
          unassignBtn.className = "unassign-master-btn";
          unassignBtn.textContent = "–û—Ç–≤—è–∑–∞—Ç—å –º–∞—Å—Ç–µ—Ä–∞";
          unassignBtn.onclick = () => {
            fetch(`/api/unassign-master/${task.id}`, { method: "POST" })
              .then(() => loadCalendarTasks());
          };
          actions.appendChild(unassignBtn);
        }

        if (!task.assignedPart) {
          const partsBtn = document.createElement("button");
          partsBtn.className = "parts-btn";
          partsBtn.textContent = "–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏";
          partsBtn.onclick = () => openPartsModal(task);
          actions.appendChild(partsBtn);
        } else {
          const unassignPartBtn = document.createElement("button");
          unassignPartBtn.className = "unassign-part-btn";
          unassignPartBtn.textContent = "–û—Ç–≤—è–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å";
          unassignPartBtn.onclick = () => {
            fetch(`/api/unassign-part/${task.id}`, { method: "POST" })
              .then(() => loadCalendarTasks());
          };
          actions.appendChild(unassignPartBtn);
        }

        const doneBtn = document.createElement("button");
        doneBtn.className = "done-btn";
        doneBtn.textContent = "–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞";
        doneBtn.onclick = () => {
          if (!task.executor || !task.assignedPart) {
            alert("–ß—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É, –Ω—É–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞ –∏ –¥–µ—Ç–∞–ª—å.");
            return;
          }
          fetch(`/api/complete-task/${task.id}`, { method: "POST" })
            .then(() => loadCalendarTasks());
        };
        actions.appendChild(doneBtn);
      }
      else if (type === "awaiting_payment") {
        const badge = document.createElement("span");
        badge.className = "status-badge awaiting";
        badge.textContent = task.type === "–æ–ø–ª–∞—á–µ–Ω–æ" ? "–û–ø–ª–∞—á–µ–Ω–æ" : "–í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã";
        actions.appendChild(badge);

        if (task.type === "–æ–ø–ª–∞—á–µ–Ω–æ" || !task.users_id) {
          const finalizeBtn = document.createElement("button");
          finalizeBtn.className = "done-btn";
          finalizeBtn.textContent = "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É";
          finalizeBtn.onclick = () => {
            fetch(`/api/finalize-task/${task.id}`, { method: "POST" })
              .then(() => loadCalendarTasks());
          };
          actions.appendChild(finalizeBtn);
        }
      }
      else if (type === "completed") {
        const badge = document.createElement("span");
        badge.className = "status-badge completed";
        badge.textContent = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ";
        actions.appendChild(badge);

        const archiveBtn = document.createElement("button");
        archiveBtn.className = "archive-btn";
        archiveBtn.textContent = "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é";
        archiveBtn.onclick = () => {
          fetch(`/api/archive-task/${task.id}`, { method: "POST" })
            .then(() => loadCalendarTasks());
        };
        actions.appendChild(archiveBtn);
      }
      else if (type === "archived") {
        const badge = document.createElement("span");
        badge.className = "status-badge archived";
        badge.textContent = "–í –∞—Ä—Ö–∏–≤–µ";
        actions.appendChild(badge);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞";
        deleteBtn.onclick = () => {
          if (confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ?")) {
            fetch(`/api/delete-task/${task.id}`, { method: "DELETE" })
              .then(() => loadCalendarTasks());
          }
        };
        actions.appendChild(deleteBtn);
      }

      container.appendChild(card);
    });
}

function loadRequests() {
    const container = document.getElementById("requestCards");
    container.innerHTML = "";
    fetch('/api/new-requests')
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = "<p>–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ.</p>";
          return;
        }

        data.sort(sortByPriority);

        data.forEach(task => {
          let priorityClass = 'priority-default';
          const p = (task.priority || "").toLowerCase();
          if (p === '–≤—ã—Å–æ–∫–∏–π') priorityClass = 'priority-high';
          else if (p === '—Å—Ä–µ–¥–Ω–∏–π') priorityClass = 'priority-medium';
          else if (p === '–Ω–∏–∑–∫–∏–π') priorityClass = 'priority-low';

          const card = document.createElement("div");
          card.className = "request-card";
          card.innerHTML = `
            <h3>${task.name}</h3>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${task.type}</p>
            <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> ${task.deadline}</p>
            <p><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> <span class="priority-badge ${priorityClass}">${task.priority || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span></p>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${task.description}</p>
          `;
          
          const button = document.createElement("button");
          button.className = "action-btn";
          button.textContent = "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫—É";
          button.onclick = () => openModal(task);
          
          card.appendChild(button);
          container.appendChild(card);
        });
      })
      .catch(() => {
        container.innerHTML = "<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫.</p>";
      });
}
  function openModal(task) {
    currentTask = task;
    
    const setText = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val || "";
    };

    setText("modalCompany", task.company);
    setText("modalContact", task.contact);
    setText("modalPhone", task.phone);
    setText("modalEmail", task.email);
    setText("modalAddress", task.address);
    setText("modalEquipment", task.equipment);
    setText("modalInstallDate", task.install_date);
    setText("modalLocation", task.location);
    setText("modalEquipmentStatus", task.equipment_status);
    setText("modalRequestDate", task.deadline);
    setText("modalProblem", task.description);
    setText("modalRepairLocation", task.repair_location);

    if (document.getElementById("prioritySelect")) {
        document.getElementById("prioritySelect").value = task.priority || "";
    }
    if (document.getElementById("repairLocationSelect")) {
        document.getElementById("repairLocationSelect").value =
          (task.repair_location === "–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏" || task.repair_location === "–Ω–∞ –±–∞–∑–µ")
            ? task.repair_location : "";
    }
    
    checkActivationReady();
    document.getElementById("modalOverlay").classList.remove("hidden");
  }

  function checkActivationReady() {
    const priority = document.getElementById("prioritySelect").value;
    const location = document.getElementById("repairLocationSelect").value;
    const validPriorities = ["–≤—ã—Å–æ–∫–∏–π", "—Å—Ä–µ–¥–Ω–∏–π", "–Ω–∏–∑–∫–∏–π"];
    const validLocations = ["–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏", "–Ω–∞ –±–∞–∑–µ"];
    const btn = document.getElementById("takeInWorkBtn");
    if (btn) {
        btn.disabled = !(validPriorities.includes(priority) && validLocations.includes(location));
    }
  }

  document.getElementById("prioritySelect").addEventListener("change", e => {
    fetch(`/api/set-priority/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ priority: e.target.value })
    }).then(checkActivationReady);
  });

  document.getElementById("repairLocationSelect").addEventListener("change", e => {
    fetch(`/api/set-location/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ location: e.target.value })
    }).then(checkActivationReady);
  });

  document.getElementById("takeInWorkBtn").addEventListener("click", () => {
    fetch(`/api/activate-request/${currentTask.id}`, { method: "POST" })
      .then(() => {
        document.getElementById("modalOverlay").classList.add("hidden");
        loadRequests();
      });
  });

  document.getElementById("deleteBtn").addEventListener("click", () => {
    const reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:");
    if (!reason) return;
    fetch(`/api/delete-request/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ reason })
    }).then(() => {
      document.getElementById("modalOverlay").classList.add("hidden");
      loadRequests();
    });
  });

  document.querySelector(".modal-close").addEventListener("click", () => {
    document.getElementById("modalOverlay").classList.add("hidden");
  });

  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const target = button.getAttribute('data-tab');
      activateTab(target);
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    activateTab("calendar");
  });

function openAssignModal(task) {
    currentTask = task;
    const modal = document.getElementById("assignModalOverlay");
    const list = document.getElementById("mastersList");
    list.innerHTML = "<p style='padding:20px; text-align:center;'>–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤...</p>";

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∏—â–µ–º —Ç–µ–≥–∏ [ ]
    const description = (task.description || "").toLowerCase();
    const allTags = [...description.matchAll(/\[(.*?)\]/g)].map(match => match[1].trim());
    
    // –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –µ—Å—Ç—å —Å–ª–æ–≤–æ "general" –∏–ª–∏ —Ç–µ–≥–æ–≤ –≤–æ–æ–±—â–µ –Ω–µ—Ç
    const isGeneralMode = allTags.length === 0 || description.includes("general");

    fetch("/api/masters")
        .then(res => res.json())
        .then(data => {
            list.innerHTML = "";
            console.log("–†–µ–∂–∏–º General:", isGeneralMode);
            console.log("–ù–∞–π–¥–µ–Ω–æ –º–∞—Å—Ç–µ—Ä–æ–≤ –≤ –ë–î:", data.length);

            data.forEach(master => {
                const masterSpec = (master.specialty || master.specialization || "").toLowerCase();
                
                // –ì–õ–ê–í–ù–û–ï –£–°–õ–û–í–ò–ï: 
                // –ï—Å–ª–∏ General ‚Äî matched –≤—Å–µ–≥–¥–∞ true. 
                // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–µ–≥–∞ —Å–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å—é –º–∞—Å—Ç–µ—Ä–∞.
                const isMatched = isGeneralMode || allTags.some(tag => masterSpec.includes(tag));
                
                const isOverloaded = (master.active_tasks_count || 0) >= 3;

                if (isMatched) {
                    const item = document.createElement("div");
                    // –ï—Å–ª–∏ –º—ã –≤ General, –∫–ª–∞—Å—Å matched –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∑–µ–ª–µ–Ω–æ–π –ø–æ–ª–æ—Å–∫–∏ —É –≤—Å–µ—Ö)
                    item.className = `master-item ${isOverloaded ? 'overloaded' : ''} ${(!isGeneralMode && isMatched) ? 'matched' : ''}`;
                    
                    item.innerHTML = `
                        <label class="master-label">
                            <input type="checkbox" value="${master.id}" ${isOverloaded ? 'disabled' : ''}>
                            <div class="master-info">
                                <div class="master-name">
                                    <span>${master.name}</span>
                                    ${isOverloaded 
                                        ? '<span class="badge-limit">–ó–∞–Ω—è—Ç 3/3</span>' 
                                        : (!isGeneralMode ? '<span class="badge-rec">–ü–æ–¥—Ö–æ–¥–∏—Ç</span>' : '<span class="badge-rec" style="background:#64748b">–û–±—â–∏–π</span>')}
                                </div>
                                <div class="master-sub">
                                    <i class="fas fa-tools"></i> ${master.specialty || "–ú–∞—Å—Ç–µ—Ä —É–Ω–∏–≤–µ—Ä—Å–∞–ª"} 
                                    <span class="task-count">‚Ä¢ –ó–∞–≥—Ä—É–∑–∫–∞: ${master.active_tasks_count || 0}/3</span>
                                </div>
                            </div>
                        </label>
                    `;
                    list.appendChild(item);
                }
            });

            if (list.innerHTML === "") {
                list.innerHTML = `<p style='padding:20px; text-align:center; color:#64748b;'>–ú–∞—Å—Ç–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î.</p>`;
            }
        });
        
    modal.classList.remove("hidden");
    
    // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π...
    document.getElementById("saveAssignBtn").onclick = () => {
        const selected = Array.from(list.querySelectorAll("input:checked")).map(cb => cb.value);
        if (selected.length === 0) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞");
            return;
        }
        fetch(`/api/assign-masters/${currentTask.id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ masters: selected })
        }).then(() => {
            document.getElementById("assignModalOverlay").classList.add("hidden");
            loadCalendarTasks();
        });
    };
}
function openPartsModal(task) {
    currentTask = task;
    const modal = document.getElementById("partsModalOverlay");
    const list = document.getElementById("partsList");
    list.innerHTML = "";

    fetch("/api/parts_en")
      .then(res => res.json())
      .then(data => {
        data.forEach(part => {
          const item = document.createElement("div");
          item.className = "part-item";
          item.innerHTML = `
            <label>
              <input type="radio" name="partSelect" value="${part.id}">
              <div class="item-info">
                <span class="item-name">${part.name}</span>
                <span class="item-sub"><i class="fas fa-boxes"></i> –í –Ω–∞–ª–∏—á–∏–∏: <strong>${part.quantity} —à—Ç.</strong></span>
              </div>
            </label>
          `;
          list.appendChild(item);
        });
      });

    document.getElementById("savePartsBtn").onclick = () => {
      const selected = document.querySelector("input[name='partSelect']:checked");
      if (!selected) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.");
        return;
      }
      fetch(`/api/assign-part/${currentTask.id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ part_id: selected.value })
      }).then(() => {
        modal.classList.add("hidden");
        loadCalendarTasks();
      });
    };
    modal.classList.remove("hidden");
  }

  function completeTask(id) {
    fetch(`/api/complete-task/${id}`, { method: "POST" })
      .then(() => loadCalendarTasks());
  }

  document.addEventListener("DOMContentLoaded", () => {
  activateTab("calendar");

  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
  const historySection = document.querySelector(".history-section");
  const historyTitle = document.querySelector(".history-title");
  if (historySection && historyTitle) {
    historyTitle.addEventListener("click", () => {
      historySection.classList.toggle("expanded");
    });
  }
});

</script>
</body>
</html>