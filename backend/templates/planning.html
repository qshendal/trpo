<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='Plane.css') }}">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h1 class="logo">üîß –¢–µ—Ö–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h1>
      <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–æ–π</p>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-tachometer-alt"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></li>
          <li><a href="{{ url_for('work_planning') }}"><i class="fas fa-calendar-alt"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</a></li>
          <li><a href="{{ url_for('equipment_registry') }}"><i class="fas fa-boxes"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a></li>
          <li><a href="{{ url_for('masters') }}"><i class="fas fa-user-cog"></i> –ú–∞—Å—Ç–µ—Ä–∞</a></li>
          <li><a href="{{ url_for('reports') }}"><i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã</a></li>
        </ul>
      </nav>
    </aside>
    <main class="dashboard">
      <header class="top-bar">
        <h2>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</h2>
      </header>

      <div class="tabs-wrapper">
        <button class="tab-button active" data-tab="calendar">üìÖ <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
        <button class="tab-button" data-tab="requests">‚ö†Ô∏è <span>–ó–∞—è–≤–∫–∏ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</span></button>
      </div>

      <div class="tab-content active" id="calendar">
        <div id="calendarTasks" class="calendar-tasks">
        </div>
      </div>

      <div class="tab-content" id="requests">
        <div id="requestCards" class="request-cards"></div>
      </div>
    </main>
  </div>

  <div id="modalOverlay" class="modal-overlay hidden">
    <div class="modal-window">
      <span class="modal-close">&times;</span>
      <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ</h2>
      <div class="modal-content">
        <p><strong>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</strong> <span id="modalCompany"></span></p>
        <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ:</strong> <span id="modalContact"></span></p>
        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="modalPhone"></span></p>
        <p><strong>Email:</strong> <span id="modalEmail"></span></p>
        <p><strong>–ê–¥—Ä–µ—Å:</strong> <span id="modalAddress"></span></p>
        <hr>
        <p><strong>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</strong> <span id="modalEquipment"></span></p>
        <p><strong>–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</strong> <span id="modalInstallDate"></span></p>
        <p><strong>–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</strong> <span id="modalLocation"></span></p>
        <p><strong>–°—Ç–∞—Ç—É—Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:</strong> <span id="modalEquipmentStatus"></span></p>
        <hr>
        <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> <span id="modalRequestDate"></span></p>
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</strong> <span id="modalProblem"></span></p>
        <p><strong>–ú–µ—Å—Ç–æ —Ä–µ–º–æ–Ω—Ç–∞:</strong> <span id="modalRepairLocation"></span></p>

        <hr>
        <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
        <select id="prioritySelect">
          <option value="">–í—ã–±—Ä–∞—Ç—å</option>
          <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
          <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
          <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
        </select>

        <label>–ú–µ—Å—Ç–æ —Ä–µ–º–æ–Ω—Ç–∞:</label>
        <select id="repairLocationSelect">
          <option value="" disabled selected hidden>–í—ã–±—Ä–∞—Ç—å</option>
          <option value="–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏">–ù–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏</option>
          <option value="–Ω–∞ –±–∞–∑–µ">–ù–∞ –±–∞–∑–µ</option>
        </select>

        <div class="modal-actions">
          <button id="takeInWorkBtn" class="action-btn" disabled>–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
          <button id="deleteBtn" class="icon-btn" title="–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    </div>
  </div>

  <script>
  let currentTask = null;

  const buttons = document.querySelectorAll('.tab-button');
  const contents = document.querySelectorAll('.tab-content');

  function activateTab(target) {
    buttons.forEach(btn => btn.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));

    const activeButton = document.querySelector(`.tab-button[data-tab="${target}"]`);
    const activeContent = document.getElementById(target);

    if (activeButton) activeButton.classList.add('active');
    if (activeContent) activeContent.classList.add('active');

    if (target === "requests") {
      loadRequests();
    } else if (target === "calendar") {
      loadCalendarTasks();
    }
  }

  function loadCalendarTasks() {
    const container = document.getElementById("calendarTasks");
    container.innerHTML = "";

    fetch('/api/calendar-tasks')
      .then(res => res.json())
      .then(data => {
        console.log("–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –∑–∞–¥–∞—á–∏:", data);
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = "<p>–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç.</p>";
          return;
        }

        data.forEach(task => {
          const card = document.createElement("div");
          card.className = "calendar-card";
          card.innerHTML = `
            <h3>${task.name}</h3>
            <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> ${task.deadline}</p>
            <p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> ${task.executor || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"}</p>
            <p><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> ${task.priority}</p>
            <div class="calendar-actions">
              <button class="action-btn">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</button>
              <button class="action-btn">–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏</button>
              <button class="action-btn">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</button>
            </div>
          `;
          container.appendChild(card);
        });
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:", err);
        container.innerHTML = "<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–±–æ—Ç.</p>";
      });
  }

  function loadRequests() {
    const container = document.getElementById("requestCards");
    container.innerHTML = "";

    fetch('/api/new-requests')
      .then(res => res.json())
      .then(data => {
        console.log("–ó–∞—è–≤–∫–∏:", data);
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = "<p>–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ.</p>";
          return;
        }

        data.forEach(task => {
          const card = document.createElement("div");
          card.className = "request-card";
          card.innerHTML = `
            <h3>${task.name}</h3>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${task.type}</p>
            <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> ${task.deadline}</p>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${task.description}</p>
          `;
          const button = document.createElement("button");
          button.className = "action-btn";
          button.textContent = "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫—É";
          button.addEventListener("click", () => openModal(task));
          card.appendChild(button);
          container.appendChild(card);
        });
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:", err);
        container.innerHTML = "<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫.</p>";
      });
  }

  function openModal(task) {
    currentTask = task;

    document.getElementById("modalCompany").textContent = task.company || "";
    document.getElementById("modalContact").textContent = task.contact || "";
    document.getElementById("modalPhone").textContent = task.phone || "";
    document.getElementById("modalEmail").textContent = task.email || "";
    document.getElementById("modalAddress").textContent = task.address || "";

    document.getElementById("modalEquipment").textContent = task.equipment || "";
    document.getElementById("modalInstallDate").textContent = task.install_date || "";
    document.getElementById("modalLocation").textContent = task.location || "";
    document.getElementById("modalEquipmentStatus").textContent = task.equipment_status || "";

    document.getElementById("modalRequestDate").textContent = task.deadline || "";
    document.getElementById("modalProblem").textContent = task.description || "";
    document.getElementById("modalRepairLocation").textContent = task.repair_location || "";

    document.getElementById("prioritySelect").value = task.priority || "";
    document.getElementById("repairLocationSelect").value =
      (task.repair_location === "–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏" || task.repair_location === "–Ω–∞ –±–∞–∑–µ")
        ? task.repair_location
        : "";

    checkActivationReady();
    document.getElementById("modalOverlay").classList.remove("hidden");
  }

  function checkActivationReady() {
    const priority = document.getElementById("prioritySelect").value;
    const location = document.getElementById("repairLocationSelect").value;
    const validPriorities = ["–≤—ã—Å–æ–∫–∏–π", "—Å—Ä–µ–¥–Ω–∏–π", "–Ω–∏–∑–∫–∏–π"];
    const validLocations = ["–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏", "–Ω–∞ –±–∞–∑–µ"];
    document.getElementById("takeInWorkBtn").disabled = !(validPriorities.includes(priority) && validLocations.includes(location));
  }

  document.getElementById("prioritySelect").addEventListener("change", e => {
    fetch(`/api/set-priority/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ priority: e.target.value })
    }).then(checkActivationReady);
  });

  document.getElementById("repairLocationSelect").addEventListener("change", e => {
    fetch(`/api/set-location/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ location: e.target.value })
    }).then(checkActivationReady);
  });

  document.getElementById("takeInWorkBtn").addEventListener("click", () => {
    fetch(`/api/activate-request/${currentTask.id}`, {
      method: "POST"
    }).then(() => {
      document.getElementById("modalOverlay").classList.add("hidden");
      loadRequests();
    });
  });

  document.getElementById("deleteBtn").addEventListener("click", () => {
    const reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:");
    if (!reason) return;

    fetch(`/api/delete-request/${currentTask.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ reason })
    }).then(() => {
      document.getElementById("modalOverlay").classList.add("hidden");
      loadRequests();
    });
  });

  document.querySelector(".modal-close").addEventListener("click", () => {
    document.getElementById("modalOverlay").classList.add("hidden");
  });

  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const target = button.getAttribute('data-tab');
      activateTab(target);
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    activateTab("calendar");
  });
</script>
</body>
</html>